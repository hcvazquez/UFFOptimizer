(function(global,exports,perf){"use strict";function fixSetTarget(param){if(!param)return;if(!param.setTargetAtTime)param.setTargetAtTime=param.setTargetValueAtTime}if(window.hasOwnProperty("webkitAudioContext")&&!window.hasOwnProperty("AudioContext")){window.AudioContext=webkitAudioContext;if(!AudioContext.prototype.hasOwnProperty("createGain"))AudioContext.prototype.createGain=AudioContext.prototype.createGainNode;if(!AudioContext.prototype.hasOwnProperty("createDelay"))AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode;if(!AudioContext.prototype.hasOwnProperty("createScriptProcessor"))AudioContext.prototype.createScriptProcessor=AudioContext.prototype.createJavaScriptNode;if(!AudioContext.prototype.hasOwnProperty("createPeriodicWave"))AudioContext.prototype.createPeriodicWave=AudioContext.prototype.createWaveTable;AudioContext.prototype.internal_createGain=AudioContext.prototype.createGain;AudioContext.prototype.createGain=function(){var node=this.internal_createGain();fixSetTarget(node.gain);return node};AudioContext.prototype.internal_createDelay=AudioContext.prototype.createDelay;AudioContext.prototype.createDelay=function(maxDelayTime){var node=maxDelayTime?this.internal_createDelay(maxDelayTime):this.internal_createDelay();fixSetTarget(node.delayTime);return node};AudioContext.prototype.internal_createBufferSource=AudioContext.prototype.createBufferSource;AudioContext.prototype.createBufferSource=function(){var node=this.internal_createBufferSource();if(!node.start){node.start=function(when,offset,duration){if(offset||duration)this.noteGrainOn(when||0,offset,duration);else this.noteOn(when||0)}}else{node.internal_start=node.start;node.start=function(when,offset,duration){if(typeof duration!=="undefined")node.internal_start(when||0,offset,duration);else node.internal_start(when||0,offset||0)}}if(!node.stop){node.stop=function(when){this.noteOff(when||0)}}else{node.internal_stop=node.stop;node.stop=function(when){node.internal_stop(when||0)}}fixSetTarget(node.playbackRate);return node};AudioContext.prototype.internal_createDynamicsCompressor=AudioContext.prototype.createDynamicsCompressor;AudioContext.prototype.createDynamicsCompressor=function(){var node=this.internal_createDynamicsCompressor();fixSetTarget(node.threshold);fixSetTarget(node.knee);fixSetTarget(node.ratio);fixSetTarget(node.reduction);fixSetTarget(node.attack);fixSetTarget(node.release);return node};AudioContext.prototype.internal_createBiquadFilter=AudioContext.prototype.createBiquadFilter;AudioContext.prototype.createBiquadFilter=function(){var node=this.internal_createBiquadFilter();fixSetTarget(node.frequency);fixSetTarget(node.detune);fixSetTarget(node.Q);fixSetTarget(node.gain);return node};if(AudioContext.prototype.hasOwnProperty("createOscillator")){AudioContext.prototype.internal_createOscillator=AudioContext.prototype.createOscillator;AudioContext.prototype.createOscillator=function(){var node=this.internal_createOscillator();if(!node.start){node.start=function(when){this.noteOn(when||0)}}else{node.internal_start=node.start;node.start=function(when){node.internal_start(when||0)}}if(!node.stop){node.stop=function(when){this.noteOff(when||0)}}else{node.internal_stop=node.stop;node.stop=function(when){node.internal_stop(when||0)}}if(!node.setPeriodicWave)node.setPeriodicWave=node.setWaveTable;fixSetTarget(node.frequency);fixSetTarget(node.detune);return node}}}if(window.hasOwnProperty("webkitOfflineAudioContext")&&!window.hasOwnProperty("OfflineAudioContext")){window.OfflineAudioContext=webkitOfflineAudioContext}})(window);(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var _=require("underscore"),pdfu=require("pd-fileutils.parser"),Patch=require("./lib/core/Patch"),Abstraction=require("./lib/core/Abstraction"),PdObject=require("./lib/core/PdObject"),mixins=require("./lib/core/mixins"),errors=require("./lib/core/errors"),portlets=require("./lib/waa/portlets"),waa=require("./lib/waa/interfaces"),pdGlob=require("./lib/global"),interfaces=require("./lib/core/interfaces"),patchIds=_.extend({},mixins.UniqueIdsMixin);require("./lib/index").declareObjects(pdGlob.library);var Pd=module.exports={start:function(opts){opts=opts||{};if(!pdGlob.isStarted){if(typeof AudioContext!=="undefined"){pdGlob.audio=opts.audio||new waa.Audio({channelCount:pdGlob.settings.channelCount,audioContext:opts.audioContext});pdGlob.clock=opts.clock||new waa.Clock({audioContext:pdGlob.audio.context,waaClock:opts.waaClock})}else{pdGlob.audio=opts.audio||interfaces.Audio;pdGlob.clock=opts.clock||interfaces.Clock}if(opts.storage)pdGlob.storage=opts.storage;else if(typeof window!=="undefined")pdGlob.storage=new waa.Storage;else pdGlob.storage=interfaces.Storage;pdGlob.audio.start();_.values(pdGlob.patches).forEach(function(patch){patch.start()});pdGlob.isStarted=true}},stop:function(){if(pdGlob.isStarted){pdGlob.isStarted=false;_.values(pdGlob.patches).forEach(function(patch){patch.stop()});pdGlob.audio.stop()}},isStarted:function(){return pdGlob.isStarted},getAudio:function(){return pdGlob.audio},send:function(name,args){pdGlob.emitter.emit("msg:"+name,args)},receive:function(name,callback){pdGlob.emitter.on("msg:"+name,callback)},registerAbstraction:function(name,patchData){if(_.isString(patchData))patchData=pdfu.parse(patchData);var CustomObject=function(patch,id,args){var patch=new Abstraction(patch,id,args);patch.patchId=patchIds._generateId();Pd._preparePatch(patch,patchData);return patch};CustomObject.prototype=Abstraction.prototype;this.registerExternal(name,CustomObject)},registerExternal:function(name,CustomObject){pdGlob.library[name]=CustomObject},createPatch:function(){var patch=this._createPatch();if(pdGlob.isStarted)patch.start();return patch},destroyPatch:function(patch){patch.stop();patch.destroy();delete pdGlob.patches[patch.patchId]},loadPatch:function(patchData){var patch=this._createPatch();if(_.isString(patchData))patchData=this.parsePatch(patchData);this._preparePatch(patch,patchData);if(pdGlob.isStarted)patch.start();return patch},parsePatch:function(patchData){if(_.isString(patchData))patchData=pdfu.parse(patchData);return patchData},_createPatch:function(){var patch=new Patch;patch.patchId=patchIds._generateId();pdGlob.patches[patch.patchId]=patch;return patch},_preparePatch:function(patch,patchData){var createdObjs={},errorList=[];patchData.nodes.forEach(function(nodeData){var proto=nodeData.proto,obj;try{obj=patch._createObject(proto,nodeData.args||[])}catch(err){if(err instanceof errors.UnknownObjectError)return errorList.push([err.message,err]);else throw err}if(obj.type=="array"&&nodeData.data)obj.setData(new Float32Array(nodeData.data),true);if(proto==="pd"||proto==="graph")Pd._preparePatch(obj,nodeData.subpatch);createdObjs[nodeData.id]=obj});patchData.connections.forEach(function(conn){var sourceObj=createdObjs[conn.source.id],sinkObj=createdObjs[conn.sink.id];if(!sourceObj||!sinkObj){var errMsg="invalid connection "+conn.source.id+".* -> "+conn.sink.id+".*";return errorList.push([errMsg,new Error(errMsg)])}try{sourceObj.o(conn.source.port).connect(sinkObj.i(conn.sink.port))}catch(err){if(err instanceof errors.InvalidPortletError){var errMsg="invalid connection "+conn.source.id+"."+conn.source.port+" -> "+conn.sink.id+"."+conn.sink.port;return errorList.push([errMsg,err])}}});patch.patchData=patchData;if(errorList.length)throw new errors.PatchLoadError(errorList)},core:{PdObject:PdObject,portlets:portlets,errors:errors},_glob:pdGlob};if(typeof window!=="undefined")window.Pd=Pd},{"./lib/core/Abstraction":3,"./lib/core/Patch":5,"./lib/core/PdObject":6,"./lib/core/errors":7,"./lib/core/interfaces":8,"./lib/core/mixins":9,"./lib/global":12,"./lib/index":14,"./lib/waa/interfaces":16,"./lib/waa/portlets":17,"pd-fileutils.parser":20,underscore:24}],2:[function(require,module,exports){var EventEmitter=require("events").EventEmitter,_=require("underscore"),utils=require("./core/utils"),mixins=require("./core/mixins"),PdObject=require("./core/PdObject"),Patch=require("./core/Patch"),pdGlob=require("./global"),portlets=require("./waa/portlets");exports.declareObjects=function(library){var _BaseControl=PdObject.extend({inletDefs:[portlets.Inlet.extend({message:function(args){this.obj._onMessageReceived(args)}})],outletDefs:[portlets.Outlet],init:function(receiveName,sendName,pdInit,defaultValue,initialValue){this._eventReceiver=new mixins.EventReceiver;if(pdInit)this.value=initialValue;else this.value=defaultValue;if(receiveName&&receiveName!=="-"&&receiveName!=="empty"){this.receiveName=receiveName;if(this._onMessageReceived){this._onMessageReceived=this._onMessageReceived.bind(this);this._eventReceiver.on(pdGlob.emitter,"msg:"+this.receiveName,this._onMessageReceived)}}if(sendName&&sendName!=="-"&&sendName!=="empty")this.sendName=sendName;if(pdInit&&this.patch){var self=this;this._onPatchStarted=function(){self._sendMessage([self.value])};this._eventReceiver.on(this.patch,"started",this._onPatchStarted)}},destroy:function(){this._eventReceiver.destroy()},_sendMessage:function(args){this.o(0).message(args);if(this.sendName)pdGlob.emitter.emit("msg:"+this.sendName,args)}});library["symbolatom"]=_BaseControl.extend({type:"symbolatom",init:function(args){var minValue=args[0]||undefined,maxValue=args[1]||undefined,receiveName=args[2],sendName=args[3];_BaseControl.prototype.init.apply(this,[receiveName,sendName,0,"symbol",0])},_onMessageReceived:function(args){var value=args[0];if(value==="bang"||_.isNumber(value)||value==="symbol"){if(_.isNumber(value))this.value="float";else if(value==="symbol")this.value=args[1];this._sendMessage(utils.timeTag(["symbol",this.value],args))}else return console.error("invalid "+value)}});var _BaseNumber=_BaseControl.extend({init:function(pdInit,receiveName,sendName,minValue,maxValue,initialValue){this._limitInput=function(value){if(_.isNumber(maxValue))value=Math.min(value,maxValue);if(_.isNumber(minValue))value=Math.max(value,minValue);return value};_BaseControl.prototype.init.apply(this,[receiveName,sendName,pdInit,0,initialValue])},_onMessageReceived:function(args){var value=args[0];if(value==="bang"||_.isNumber(value)){if(_.isNumber(value))this.value=value;this._sendMessage(utils.timeTag([this._limitInput(this.value)],args))}else return console.error("invalid "+value)}});library["floatatom"]=_BaseNumber.extend({type:"floatatom",init:function(args){var minValue=args[0]||undefined,maxValue=args[1]||undefined,receiveName=args[2],sendName=args[3];_BaseNumber.prototype.init.apply(this,[0,receiveName,sendName,minValue,maxValue,0])}});library["nbx"]=_BaseNumber.extend({type:"nbx",init:function(args){var minValue=args[0]||undefined,maxValue=args[1]||undefined,pdInit=args[2]||0,receiveName=args[3],sendName=args[4],initialValue=args[5]||0;_BaseNumber.prototype.init.apply(this,[pdInit,receiveName,sendName,minValue,maxValue,initialValue])}});library["bng"]=_BaseControl.extend({type:"bng",init:function(args){var pdInit=args[0]||0,receiveName=args[1],sendName=args[2];_BaseControl.prototype.init.apply(this,[receiveName,sendName,pdInit,"bang","bang"])},_onMessageReceived:function(args){this._sendMessage(utils.timeTag(["bang"],args))}});library["tgl"]=_BaseControl.extend({type:"tgl",init:function(args){var pdInit=args[0]||0,receiveName=args[1],sendName=args[2],initialValue=args[3]||0,nonZeroValue=_.isNumber(args[4])?args[4]:1;_BaseControl.prototype.init.apply(this,[receiveName,sendName,pdInit,0,initialValue]);this.nonZeroValue=nonZeroValue},_onMessageReceived:function(args){var value=args[0];if(value==="bang"){if(this.value===0)this.value=this.nonZeroValue;else this.value=0;this._sendMessage(utils.timeTag([this.value],args))}else if(_.isNumber(value)){if(value===0)this.value=0;else this.value=this.nonZeroValue;this._sendMessage(utils.timeTag([value],args))}else return console.error("invalid message received "+args)}});var _BaseSlider=_BaseNumber.extend({init:function(args){var minValue=args[0]||0,maxValue=_.isNumber(args[1])?args[1]:127,pdInit=args[2]||0,receiveName=args[3],sendName=args[4],initialValue=args[5]||0;_BaseNumber.prototype.init.apply(this,[pdInit,receiveName,sendName,minValue,maxValue,initialValue])}});library["hsl"]=_BaseSlider.extend({type:"hsl"});library["vsl"]=_BaseSlider.extend({type:"vsl"});var _BaseRadio=_BaseControl.extend({init:function(args){var oldNew=args[0],pdInit=args[1],number=_.isNumber(args[2])?args[2]:8,receiveName=args[3],sendName=args[4],initialValue=args[5]||0;this._limitInput=function(value){return Math.floor(Math.min(Math.max(value,0),number-1))};_BaseControl.prototype.init.apply(this,[receiveName,sendName,pdInit,0,initialValue])},_onMessageReceived:function(args){var value=args[0];if(value==="bang"||_.isNumber(value)){if(_.isNumber(value))this.value=value;this._sendMessage(utils.timeTag([this._limitInput(this.value)],args))}else return console.error("invalid "+value)}});library["hradio"]=_BaseRadio.extend({type:"hradio"});library["vradio"]=_BaseRadio.extend({type:"vradio"});library["vu"]=_BaseControl.extend({init:function(args){var receiveName=args[0];_BaseControl.prototype.init.apply(this,[receiveName,undefined,0,0,0])},_onMessageReceived:function(args){this._sendMessage(args)}})}},{"./core/Patch":5,"./core/PdObject":6,"./core/mixins":9,"./core/utils":11,"./global":12,"./waa/portlets":17,events:18,underscore:24}],3:[function(require,module,exports){var _=require("underscore"),Patch=require("./Patch");var Abstraction=module.exports=function(patch,id,args){Patch.apply(this,arguments)};_.extend(Abstraction.prototype,Patch.prototype,{getPatchRoot:function(){return this}})},{"./Patch":5,underscore:24}],4:[function(require,module,exports){var _=require("underscore"),inherits=require("util").inherits,errors=require("./errors"),portlets=require("./portlets"),utils=require("./utils");var BaseNode=module.exports=function(patch,id,args){args=args||[];var self=this;this.id=id;this.patch=patch;this.inlets=this.inletDefs.map(function(inletType,i){return new inletType(self,i)});this.outlets=this.outletDefs.map(function(outletType,i){return new outletType(self,i)});this.init(args)};_.extend(BaseNode.prototype,{endPoint:false,doResolveArgs:false,outletDefs:[],inletDefs:[],init:function(){},start:function(){},stop:function(){},destroy:function(){},i:function(id){if(id<this.inlets.length)return this.inlets[id];else throw new errors.InvalidPortletError("invalid inlet "+id)},o:function(id){if(id<this.outlets.length)return this.outlets[id];else throw new errors.InvalidPortletError("invalid outlet "+id)},startPortlets:function(){this.outlets.forEach(function(outlet){outlet.start()});this.inlets.forEach(function(inlet){inlet.start()})},stopPortlets:function(){this.outlets.forEach(function(outlet){outlet.stop()});this.inlets.forEach(function(inlet){inlet.stop()})}})},{"./errors":7,"./portlets":10,"./utils":11,underscore:24,util:27}],5:[function(require,module,exports){var _=require("underscore"),EventEmitter=require("events").EventEmitter,mixins=require("./mixins"),utils=require("./utils"),BaseNode=require("./BaseNode"),errors=require("./errors"),pdGlob=require("../global");var Patch=module.exports=function(){BaseNode.apply(this,arguments);this.objects=[];this.endPoints=[];this.patchId=null;this.patchData=null;this.blockSize=pdGlob.settings.blockSize};_.extend(Patch.prototype,BaseNode.prototype,mixins.UniqueIdsMixin,EventEmitter.prototype,{type:"patch",init:function(args){this.args=args},start:function(){this.startObjects();this.startPortlets()},stop:function(){this.stopObjects();this.stopPortlets()},destroy:function(){this.objects.forEach(function(obj){obj.destroy()})},startObjects:function(){this.objects.forEach(function(obj){if(obj.startObjects)obj.startObjects();else obj.start()})},stopObjects:function(){this.objects.forEach(function(obj){if(obj.stopObjects)obj.stopObjects();else obj.stop()})},startPortlets:function(){this.objects.forEach(function(obj){obj.startPortlets()});this.emit("started")},stopPortlets:function(){this.objects.forEach(function(obj){obj.stopPortlets()});this.emit("stopped")},createObject:function(type,objArgs){var obj=this._createObject(type,objArgs);if(pdGlob.isStarted){obj.start();obj.startPortlets()}return obj},_createObject:function(type,objArgs){var obj;objArgs=objArgs||[];if(pdGlob.library.hasOwnProperty(type)){var constructor=pdGlob.library[type];if(constructor.prototype.doResolveArgs)objArgs=this.resolveArgs(objArgs);obj=new constructor(this,this._generateId(),objArgs)}else throw new errors.UnknownObjectError(type);this.objects[obj.id]=obj;if(obj.endPoint)this.endPoints.push(obj);if(isInletObject(obj))this.inlets.push(obj.inlets[0]);if(isOutletObject(obj))this.outlets.push(obj.outlets[0]);return obj},resolveArgs:function(args){var cleaned=args.slice(0),dollar0=this.getPatchRoot().patchId,patchArgs,matched;patchArgs=[dollar0].concat(this.args);args.forEach(function(arg,i){if(arg==="b")cleaned[i]="bang";else if(arg==="f")cleaned[i]="float";else if(arg==="s")cleaned[i]="symbol";else if(arg==="a")cleaned[i]="anything";else if(arg==="l")cleaned[i]="list"});return utils.getDollarResolver(cleaned)(patchArgs)},getPatchRoot:function(){if(this.patch)return this.patch.getPatchRoot();else return this}});var isInletObject=function(obj){return[pdGlob.library["inlet"],pdGlob.library["inlet~"]].some(function(type){return obj instanceof type})};var isOutletObject=function(obj){return[pdGlob.library["outlet"],pdGlob.library["outlet~"]].some(function(type){return obj instanceof type})}},{"../global":12,"./BaseNode":4,"./errors":7,"./mixins":9,"./utils":11,events:18,underscore:24}],6:[function(require,module,exports){var _=require("underscore"),inherits=require("util").inherits,portlets=require("./portlets"),utils=require("./utils"),BaseNode=require("./BaseNode"),Patch=require("./Patch"),pdGlob=require("../global");var PdObject=module.exports=function(){BaseNode.apply(this,arguments)};PdObject.extend=utils.chainExtend;_.extend(PdObject.prototype,BaseNode.prototype,{doResolveArgs:true})},{"../global":12,"./BaseNode":4,"./Patch":5,"./portlets":10,"./utils":11,underscore:24,util:27}],7:[function(require,module,exports){var _=require("underscore");var PatchLoadError=exports.PatchLoadError=function PatchLoadError(errorList){this.name="PatchLoadError";this.errorList=errorList;this.message=_.pluck(errorList,0).join("\n");this.stack=(new Error).stack};PatchLoadError.prototype=Object.create(Error.prototype);PatchLoadError.prototype.constructor=PatchLoadError;var UnknownObjectError=exports.UnknownObjectError=function UnknownObjectError(type){this.name="UnknownObjectError";this.message="unknown object "+type;this.objectType=type;this.stack=(new Error).stack};UnknownObjectError.prototype=Object.create(Error.prototype);UnknownObjectError.prototype.constructor=UnknownObjectError;var InvalidPortletError=exports.InvalidPortletError=function InvalidPortletError(msg){this.name="InvalidPortletError";this.message=msg;this.stack=(new Error).stack};InvalidPortletError.prototype=Object.create(Error.prototype);InvalidPortletError.prototype.constructor=InvalidPortletError},{underscore:24}],8:[function(require,module,exports){exports.Clock={time:0,schedule:function(func,time,repetition){},unschedule:function(event){}};exports.Audio={sampleRate:44100,start:function(){},stop:function(){},decode:function(arrayBuffer,done){done(null,arrayBuffer)}};exports.Storage={get:function(uri,done){}}},{}],9:[function(require,module,exports){var EventEmitter=require("events").EventEmitter,_=require("underscore"),pdGlob=require("../global");exports.NamedMixin={nameIsUnique:false,setName:function(name){if(!_.isString(name))return console.error("expected ["+this.type+"] name to be a string, got "+name);var oldName=this.name;this.emit("changing:name",oldName,name);this.name=name;pdGlob.namedObjects.register(this,this.type,name,this.nameIsUnique,oldName);this.emit("changed:name",oldName,name)},destroy:function(){pdGlob.namedObjects.unregister(this,this.type,this.name)}};var EventEmitterMixin=exports.EventEmitterMixin=_.extend({},EventEmitter.prototype,{destroy:function(){this.removeAllListeners()}});var Reference=exports.Reference=function(referencedType){this.referencedType=referencedType;this._onNewObject=null;this._onChangedName=null;this.resolved=null;this._eventName="namedObjects:registered:"+this.referencedType;this._eventReceiver=new EventReceiver};_.extend(Reference.prototype,EventEmitterMixin,{set:function(name){var self=this,resolved=pdGlob.namedObjects.get(this.referencedType,name)[0];this.name=name;this._stopListening();if(resolved)this._setResolved(resolved);else{this._setResolved(null);this._onNewObject=function(obj){if(obj.name===name){self._stopListening();self._setResolved(obj)}};this._eventReceiver.on(pdGlob.emitter,this._eventName,this._onNewObject)}},destroy:function(){this._eventReceiver.destroy();EventEmitterMixin.destroy.apply(this)},_setResolved:function(newObj){var self=this,oldObj=this.resolved;this.resolved=newObj;if(oldObj)oldObj.removeListener("changing:name",self._onChangedName);if(newObj){this._onChangedName=function(){self._setResolved(null)};this._eventReceiver.on(newObj,"changing:name",this._onChangedName)}this.emit("changed",newObj,oldObj)},_stopListening:function(){if(this._onNewObject){this._eventReceiver.removeListener(pdGlob.emitter,this._eventName,this._onNewObject);this._onNewObject=null}}});exports.UniqueIdsMixin={_generateId:function(){this._idCounter++;return this._idCounter},_idCounter:-1};var EventReceiver=exports.EventReceiver=function(){this._handlers=[]};_.extend(EventReceiver.prototype,{addListener:function(emitter,eventName,handler){this._handlers.push([emitter,eventName,handler]);emitter.addListener(eventName,handler)},once:function(emitter,eventName,handler){var self=this,handlerData=[emitter,eventName,handler];this._handlers.push(handlerData);emitter.once(eventName,handler)},removeListener:function(emitter,eventName,handler){this._handlers=_.reject(this._handlers,function(handlerData){var rejected=handlerData[0]===emitter&&handlerData[1]===eventName&&handlerData[2]===handler;if(rejected)emitter.removeListener(eventName,handler);return rejected})},destroy:function(){this._handlers.forEach(function(handlerData){handlerData[0].removeListener(handlerData[1],handlerData[2])});this._handlers=[]}});EventReceiver.prototype.on=EventReceiver.prototype.addListener},{"../global":12,events:18,underscore:24}],10:[function(require,module,exports){var _=require("underscore"),utils=require("./utils");var Portlet=exports.Portlet=function(obj,id){this.obj=obj;this.id=id;this.connections=[];this.init()};_.extend(Portlet.prototype,{crossPatch:false,init:function(){},start:function(){},stop:function(){},message:function(args){},connection:function(otherPortlet){},disconnection:function(otherPortlet){},connect:function(otherPortlet){if(this.connections.indexOf(otherPortlet)!==-1)return false;if(!(this.crossPatch||otherPortlet.crossPatch)&&this.obj.patch!==otherPortlet.obj.patch)throw new Error("cannot connect objects that belong to different patches");this.connections.push(otherPortlet);otherPortlet.connect(this);this.connection(otherPortlet);return true},disconnect:function(otherPortlet){var connInd=this.connections.indexOf(otherPortlet);if(connInd===-1)return false;this.connections.splice(connInd,1);otherPortlet.disconnect(this);this.disconnection(otherPortlet);return true}});Portlet.extend=utils.chainExtend;var Inlet=exports.Inlet=Portlet.extend({});var Outlet=exports.Outlet=Portlet.extend({})},{"./utils":11,underscore:24}],11:[function(require,module,exports){var _=require("underscore"),pdGlob=require("../global");var dollarVarRe=/\$(\d+)/,dollarVarReGlob=/\$(\d+)/g;exports.getDollarResolver=function(rawOutArray){rawOutArray=rawOutArray.slice(0);var getElem=function(array,ind){if(ind>=array.length||ind<0)throw new Error("$"+(ind+1)+": argument number out of range");return array[ind]};var transfer=rawOutArray.map(function(rawOutVal){var matchOnce=dollarVarRe.exec(rawOutVal);if(matchOnce&&matchOnce[0]===rawOutVal){return function(rawOutVal){var inInd=parseInt(matchOnce[1],10);return function(inArray){return getElem(inArray,inInd)}}(rawOutVal)}else if(matchOnce){return function(rawOutVal){var allMatches=[],matched;while(matched=dollarVarReGlob.exec(rawOutVal)){allMatches.push([matched[0],parseInt(matched[1],10)])}return function(inArray){var outVal=rawOutVal.substr(0);allMatches.forEach(function(matched){outVal=outVal.replace(matched[0],getElem(inArray,matched[1]))});return outVal}}(rawOutVal)}else{return function(outVal){return function(){return outVal}}(rawOutVal)}});return function(inArray){return transfer.map(function(func,i){return func(inArray)})}};exports.chainExtend=function(){var sources=Array.prototype.slice.call(arguments,0),parent=this,child=function(){parent.apply(this,arguments)};child.prototype=new parent;_.extend.apply(this,[child.prototype,parent.prototype].concat(sources));child.extend=this.extend;return child};exports.timeTag=function(args,timeTag){if(!timeTag)return args;else if(_.isNumber(timeTag))args.timeTag=timeTag;else args.timeTag=timeTag.timeTag;return args};exports.getTimeTag=function(args){return args&&args.timeTag||pdGlob.clock&&pdGlob.clock.time||0}},{"../global":12,underscore:24}],12:[function(require,module,exports){var _=require("underscore"),EventEmitter=require("events").EventEmitter;exports.settings={blockSize:16384,channelCount:2};exports.isStarted=false;var emitter=exports.emitter=new EventEmitter;emitter.emit=function(eventName){var valid=false;if(_.contains([],eventName)||eventName.indexOf("msg:")===0||eventName.indexOf("namedObjects:registered")===0||eventName.indexOf("namedObjects:unregistered")===0)EventEmitter.prototype.emit.apply(this,arguments);else throw new Error("unknown event : "+eventName)};exports.library={};exports.patches={};exports.audio=null;exports.clock=null;exports.storage=null;exports.namedObjects={register:function(obj,type,name,nameIsUnique,oldName){var nameMap,objList;this._store[type]=nameMap=this._store[type]||{};nameMap[name]=objList=nameMap[name]||[];if(objList.indexOf(obj)===-1){if(nameIsUnique&&objList.length>0)throw new Error("there is already a "+type+' with name "'+name+'"');objList.push(obj)}if(oldName){objList=nameMap[oldName];objList.splice(objList.indexOf(obj),1)}exports.emitter.emit("namedObjects:registered:"+type,obj)},unregister:function(obj,type,name){var nameMap=this._store[type],objList=nameMap?nameMap[name]:null,ind;if(!objList)return;ind=objList.indexOf(obj);if(ind===-1)return;objList.splice(ind,1);exports.emitter.emit("namedObjects:unregistered:"+type,obj)},get:function(type,name){return(this._store[type]||{})[name]||[]},reset:function(){this._store={}},_store:{}}},{events:18,underscore:24}],13:[function(require,module,exports){var _=require("underscore"),utils=require("./core/utils"),mixins=require("./core/mixins"),PdObject=require("./core/PdObject"),Patch=require("./core/Patch"),pdGlob=require("./global"),portlets=require("./waa/portlets");exports.declareObjects=function(library){library["receive"]=library["r"]=PdObject.extend(mixins.NamedMixin,mixins.EventEmitterMixin,{type:"receive",outletDefs:[portlets.Outlet],abbreviations:["r"],init:function(args){var name=args[0],self=this;this._eventReceiver=new mixins.EventReceiver;this._onMessageReceived=this._onMessageReceived.bind(this);this._eventReceiver.on(this,"changed:name",function(oldName,newName){if(oldName)self._eventReceiver.removeListener(pdGlob.emitter,"msg:"+oldName,self._onMessageReceived);self._eventReceiver.on(pdGlob.emitter,"msg:"+newName,self._onMessageReceived)});this.setName(name)},destroy:function(){mixins.NamedMixin.destroy.apply(this,arguments);this._eventReceiver.destroy();mixins.EventEmitterMixin.destroy.apply(this,arguments)},_onMessageReceived:function(args){this.o(0).message(args)}});library["send"]=library["s"]=PdObject.extend(mixins.NamedMixin,mixins.EventEmitterMixin,{type:"send",inletDefs:[portlets.Inlet.extend({message:function(args){pdGlob.emitter.emit("msg:"+this.obj.name,args)}})],abbreviations:["s"],init:function(args){this.setName(args[0])},destroy:function(){mixins.NamedMixin.destroy.apply(this,arguments);mixins.EventEmitterMixin.destroy.apply(this,arguments)}});library["msg"]=PdObject.extend({type:"msg",doResolveArgs:false,inletDefs:[portlets.Inlet.extend({message:function(args){var timeTag=args.timeTag;args=args.slice(0);args.unshift(0);for(var i=0;i<this.obj.resolvers.length;i++){var resolver=this.obj.resolvers[i];this.obj.outlets[0].message(utils.timeTag(resolver(args),timeTag))}}})],outletDefs:[portlets.Outlet],init:function(args){this.createResolvers(args)},createResolvers:function(args){var argsGroups=[[]];for(var i=0;i<args.length;i++){var arg=args[i];if(arg==","){argsGroups.push([])}else{argsGroups[argsGroups.length-1].push(arg)}}if(argsGroups[argsGroups.length-1].length==0){argsGroups.pop()}this.resolvers=[];for(var i in argsGroups){var argsGroup=argsGroups[i];this.resolvers.push(utils.getDollarResolver(argsGroup))}}});library["print"]=PdObject.extend({type:"print",inletDefs:[portlets.Inlet.extend({message:function(args){console.log(this.obj.prefix?[this.obj.prefix].concat(args):args)}})],init:function(args){this.prefix=args[0]||"print"}});library["text"]=PdObject.extend({type:"text",init:function(args){this.text=args[0]}});library["loadbang"]=PdObject.extend({type:"loadbang",outletDefs:[portlets.Outlet],init:function(){var self=this;this._eventReceiver=new mixins.EventReceiver;this._onPatchStarted=function(){self.o(0).message(["bang"])};this._eventReceiver.on(this.patch,"started",this._onPatchStarted)},destroy:function(){this._eventReceiver.destroy()}});var _NumberBase=PdObject.extend({inletDefs:[portlets.Inlet.extend({message:function(args){var val=args[0];if(val!=="bang")this.obj.setVal(val);this.obj.o(0).message(utils.timeTag([this.obj.val],args))}}),portlets.Inlet.extend({message:function(args){var val=args[0];this.obj.setVal(val)}})],outletDefs:[portlets.Outlet],init:function(args){var val=args[0];this.setVal(val||0)},setVal:function(val){this.val=val}});library["float"]=library["f"]=_NumberBase.extend({type:"float",setVal:function(val){if(!_.isNumber(val))return console.error("invalid [float] value "+val);this.val=val}});library["int"]=library["i"]=_NumberBase.extend({type:"int",setVal:function(val){if(!_.isNumber(val))return console.error("invalid [int] value "+val);this.val=Math.floor(val)}});var _TwoVarFunctionBase=PdObject.extend({inletDefs:[portlets.Inlet.extend({message:function(args){var val=args[0];if(_.isNumber(val))this.obj.valLeft=val;else if(val!=="bang")console.error("invalid message : "+args);this.obj.o(0).message(utils.timeTag([this.obj.compute()],args))}}),portlets.Inlet.extend({message:function(args){var val=args[0];if(!_.isNumber(val))return console.error("invalid operand for ["+this.obj.type+"] "+val);this.obj.valRight=val}})],outletDefs:[portlets.Outlet],init:function(args){this.valRight=args[0]||0;this.valLeft=0},compute:function(){return}});library["+"]=_TwoVarFunctionBase.extend({type:"+",compute:function(){return this.valLeft+this.valRight}});library["-"]=_TwoVarFunctionBase.extend({type:"-",compute:function(){return this.valLeft-this.valRight}});library["*"]=_TwoVarFunctionBase.extend({type:"*",compute:function(){return this.valLeft*this.valRight}});library["/"]=_TwoVarFunctionBase.extend({type:"/",compute:function(){return this.valRight==0?0:this.valLeft/this.valRight}});library["min"]=_TwoVarFunctionBase.extend({type:"min",compute:function(){return Math.min(this.valLeft,this.valRight)}});library["max"]=_TwoVarFunctionBase.extend({
type:"max",compute:function(){return Math.max(this.valLeft,this.valRight)}});library["mod"]=library["%"]=_TwoVarFunctionBase.extend({type:"mod",compute:function(){if(this.valRight<=0)return 0;if(this.valLeft<0)return this.valRight+this.valLeft%this.valRight;return this.valLeft%this.valRight}});library["pow"]=_TwoVarFunctionBase.extend({type:"pow",compute:function(){return Math.pow(this.valLeft,this.valRight)}});var _OneVarFunctionBase=PdObject.extend({inletDefs:[portlets.Inlet.extend({message:function(args){var inVal=args[0];this.obj.checkInput(inVal);this.obj.o(0).message(utils.timeTag([this.obj.compute(inVal)],args))}})],outletDefs:[portlets.Outlet],checkInput:function(inVal){},compute:function(){return}});var _OneNumVarFunctionBase=_OneVarFunctionBase.extend({checkInput:function(inVal){if(!_.isNumber(inVal))return console.error("invalid ["+this.type+"] value "+inVal)}});library["cos"]=_OneNumVarFunctionBase.extend({type:"cos",compute:function(inVal){return Math.cos(inVal)}});library["sin"]=_OneNumVarFunctionBase.extend({type:"sin",compute:function(inVal){return Math.sin(inVal)}});library["tan"]=_OneNumVarFunctionBase.extend({type:"tan",compute:function(inVal){return Math.tan(inVal)}});library["atan2"]=_TwoVarFunctionBase.extend({type:"atan2",compute:function(){return Math.atan2(this.valRight,this.valLeft)}});library["atan"]=_OneNumVarFunctionBase.extend({type:"atan",compute:function(inVal){return Math.atan(inVal)}});library["exp"]=_OneNumVarFunctionBase.extend({type:"exp",compute:function(inVal){return Math.exp(inVal)}});library["log"]=_OneNumVarFunctionBase.extend({type:"log",compute:function(inVal){return Math.log(inVal)}});library["abs"]=_OneNumVarFunctionBase.extend({type:"abs",compute:function(inVal){return Math.abs(inVal)}});library["sqrt"]=_OneNumVarFunctionBase.extend({type:"sqrt",compute:function(inVal){return Math.sqrt(inVal)}});library["wrap"]=_OneNumVarFunctionBase.extend({type:"wrap",compute:function(inVal){return inVal-Math.floor(inVal)}});library["mtof"]=_OneNumVarFunctionBase.extend({type:"mtof",maxMidiNote:8.17579891564*Math.exp(.057762265*1499),compute:function(note){var out=0;if(!_.isNumber(note))return console.error("invalid [mtof] value "+note);if(note<=-1500)out=0;else if(note>1499)out=this.maxMidiNote;else out=8.17579891564*Math.exp(.057762265*note);return out}});library["ftom"]=_OneNumVarFunctionBase.extend({type:"ftom",compute:function(freq){if(!_.isNumber(freq))return console.error("invalid [ftom] value "+freq);if(freq<=0)return-1500;return Math.log(freq*.122312206)*17.312340491}});library["rmstodb"]=_OneNumVarFunctionBase.extend({type:"rmstodb",compute:function(inVal){return inVal<=0?0:20*Math.log(inVal)/Math.LN10+100}});library["dbtorms"]=_OneNumVarFunctionBase.extend({type:"dbtorms",compute:function(inVal){return inVal<=0?0:Math.exp(Math.LN10*(inVal-100)/20)}});library["powtodb"]=_OneNumVarFunctionBase.extend({type:"powtodb",compute:function(inVal){return inVal<=0?0:10*Math.log(inVal)/Math.LN10+100}});library["dbtopow"]=_OneNumVarFunctionBase.extend({type:"dbtopow",compute:function(inVal){return inVal<=0?0:Math.exp(Math.LN10*(inVal-100)/10)}});library["samplerate~"]=_OneVarFunctionBase.extend({type:"samplerate~",compute:function(){return pdGlob.audio.sampleRate}});library["spigot"]=PdObject.extend({type:"spigot",inletDefs:[portlets.Inlet.extend({message:function(args){if(this.obj.passing)this.obj.o(0).message(args)}}),portlets.Inlet.extend({message:function(args){var val=args[0];this.obj.setPassing(val)}})],outletDefs:[portlets.Outlet],init:function(args){var val=args[0];this.setPassing(val||0)},setPassing:function(val){if(!_.isNumber(val))return console.error("invalid [spigot] value "+val);this.passing=Boolean(val)}});library["trigger"]=library["t"]=PdObject.extend({type:"trigger",inletDefs:[portlets.Inlet.extend({message:function(args){var i,length,filter,msg;for(i=this.obj.filters.length-1;i>=0;i--){filter=this.obj.filters[i];if(filter==="bang")this.obj.o(i).message(utils.timeTag(["bang"],args));else if(filter==="list"||filter==="anything")this.obj.o(i).message(args);else if(filter==="float"||_.isNumber(filter)){msg=args[0];if(_.isNumber(msg))this.obj.o(i).message(utils.timeTag([msg],args));else this.obj.o(i).message(utils.timeTag([0],args))}else if(filter==="symbol"){msg=args[0];if(msg==="bang")this.obj.o(i).message(utils.timeTag(["symbol"],args));else if(_.isNumber(msg))this.obj.o(i).message(utils.timeTag(["float"],args));else if(_.isString(msg))this.obj.o(i).message(utils.timeTag([msg],args));else throw new Error("Got unexpected input "+args)}else this.obj.o(i).message(utils.timeTag(["bang"],args))}}})],init:function(args){var i,length;if(args.length===0)args=["bang","bang"];for(i=0,length=args.length;i<length;i++)this.outlets.push(new portlets.Outlet(this,i));this.filters=args}});var _PackInlet0=portlets.Inlet.extend({message:function(args){var msg=args[0];if(msg!=="bang")this.obj.memory[0]=msg;this.obj.o(0).message(utils.timeTag(this.obj.memory.slice(0),args))}});var _PackInletN=portlets.Inlet.extend({message:function(args){var msg=args[0];this.obj.memory[this.id]=msg}});library["pack"]=PdObject.extend({type:"pack",outletDefs:[portlets.Outlet],init:function(args){var i,length=args.length;if(length===0)args=["float","float"];length=args.length;this.filters=args;this.memory=new Array(length);for(i=0;i<length;i++){if(i===0)this.inlets[i]=new _PackInlet0(this,i);else this.inlets[i]=new _PackInletN(this,i);if(args[i]==="float")this.memory[i]=0;else if(args[i]==="symbol")this.memory[i]="symbol";else this.memory[i]=args[i]}}});library["select"]=library["sel"]=PdObject.extend({type:"select",inletDefs:[portlets.Inlet.extend({message:function(args){var ind,msg=args[0];if((ind=this.obj.filters.indexOf(msg))!==-1)this.obj.o(ind).message(utils.timeTag(["bang"],args));else this.obj.outlets.slice(-1)[0].message(utils.timeTag([msg],args))}}),portlets.Inlet.extend({message:function(args){if(this.obj.filters.length<=1)this.obj.filters=args}})],init:function(args){var i,length;if(args.length===0)args=[0];if(args.length>1)this.inlets.pop();for(i=0,length=args.length;i<length;i++)this.outlets[i]=new portlets.Outlet(this,i);this.outlets[i]=new portlets.Outlet(this,i);this.filters=args}});library["moses"]=PdObject.extend({type:"moses",inletDefs:[portlets.Inlet.extend({message:function(args){var val=args[0];if(!_.isNumber(val))return console.error("invalid [moses] value "+val);if(val<this.obj.val)this.obj.o(0).message(utils.timeTag([val],args));else this.obj.o(1).message(utils.timeTag([val],args))}}),portlets.Inlet.extend({message:function(args){var val=args[0];this.obj.setVal(val)}})],outletDefs:[portlets.Outlet,portlets.Outlet],init:function(args){var val=args[0];this.setVal(val||0)},setVal:function(val){if(!_.isNumber(val))return console.error("invalid [moses] value "+val);this.val=val}});library["clip"]=PdObject.extend({type:"clip",inletDefs:[portlets.Inlet.extend({message:function(args){var val=args[0];if(!_.isNumber(val))return console.error("invalid [clip] value "+val);if(val<this.obj.min)this.obj.o(0).message(utils.timeTag([this.obj.min],args));else if(val>this.obj.max)this.obj.o(0).message(utils.timeTag([this.obj.max],args));else this.obj.o(0).message(utils.timeTag([val],args))}}),portlets.Inlet.extend({message:function(args){var val=args[0];this.obj.setMin(val)}}),portlets.Inlet.extend({message:function(args){var val=args[0];this.obj.setMax(val)}})],outletDefs:[portlets.Outlet],init:function(args){this.setMin(args[0]||0);this.setMax(args[1]||0)},setMin:function(val){if(!_.isNumber(val))return console.error("invalid [clip] min value "+val);this.min=val},setMax:function(val){if(!_.isNumber(val))return console.error("invalid [clip] max value "+val);this.max=val}});library["swap"]=PdObject.extend({type:"swap",inletDefs:[portlets.Inlet.extend({message:function(args){var val=args[0];if(!_.isNumber(val))return console.error("invalid [swap] value "+val);this.obj.o(1).message(utils.timeTag([val],args));this.obj.o(0).message(utils.timeTag([this.obj.val],args))}}),portlets.Inlet.extend({message:function(args){var val=args[0];this.obj.setVal(val)}})],outletDefs:[portlets.Outlet,portlets.Outlet],init:function(args){var val=args[0];this.setVal(val||0)},setVal:function(val){if(!_.isNumber(val))return console.error("invalid [swap] value "+val);this.val=val}});library["until"]=PdObject.extend({type:"until",inletDefs:[portlets.Inlet.extend({message:function(args){var val=args[0];if(val==="bang"){this.obj._startLoop(args.timeTag)}else{if(!_.isNumber(val))return console.error("invalid [until] value "+val);this.obj._startLoop(args.timeTag,val)}}}),portlets.Inlet.extend({message:function(args){var val=args[0];if(val!=="bang")return console.error("invalid command for [until] "+val);this.obj._stopLoop()}})],outletDefs:[portlets.Outlet],init:function(){this._looping=false},_startLoop:function(timeTag,max){this._looping=true;var self=this,counter=0,sendBang=function(){self.o(0).message(utils.timeTag(["bang"],timeTag))};if(_.isNumber(max)){while(this._looping&&counter<max){sendBang();counter++}}else while(this._looping)sendBang();this._looping=false},_stopLoop:function(){this._looping=false}});library["random"]=PdObject.extend({type:"random",inletDefs:[portlets.Inlet.extend({message:function(args){var msg=args[0];if(msg==="bang")this.obj.o(0).message(utils.timeTag([Math.floor(Math.random()*this.obj.max)],args));else if(msg==="seed")1}}),portlets.Inlet.extend({message:function(args){var msg=args[0];this.obj.setMax(msg)}})],outletDefs:[portlets.Outlet],init:function(args){var maxInt=args[0];this.setMax(maxInt||1)},setMax:function(maxInt){if(!_.isNumber(maxInt))return console.error("invalid [random] value "+maxInt);this.max=maxInt}});library["metro"]=PdObject.extend({type:"metro",inletDefs:[portlets.Inlet.extend({message:function(args){var msg=args[0];if(msg==="bang")this.obj._restartMetroTick(utils.getTimeTag(args));else if(msg==="stop")this.obj._stopMetroTick();else{if(!_.isNumber(msg))return console.error("invalid [metro] value "+msg);if(msg===0)this.obj._stopMetroTick();else this.obj._restartMetroTick(utils.getTimeTag(args))}}}),portlets.Inlet.extend({message:function(args){var rate=args[0];this.obj.setRate(rate);this.obj._metroTick=this.obj._metroTickRateChange}})],outletDefs:[portlets.Outlet],init:function(args){var rate=args[0];this.setRate(rate||0);this._metroHandle=null;this._metroTick=this._metroTickNormal},setRate:function(rate){if(!_.isNumber(rate))return console.error("invalid [metro] rate "+rate);this.rate=Math.max(rate,1)},destroy:function(){this._stopMetroTick()},_startMetroTick:function(timeTag){var self=this;if(this._metroHandle===null){this._metroHandle=pdGlob.clock.schedule(function(event){self._metroTick(event.timeTag)},timeTag,this.rate)}},_stopMetroTick:function(){if(this._metroHandle!==null){pdGlob.clock.unschedule(this._metroHandle);this._metroHandle=null}},_restartMetroTick:function(timeTag){if(this._metroTick===this._metroTickRateChange)this._metroTick=this._metroTickNormal;this._stopMetroTick();this._startMetroTick(timeTag)},_metroTickNormal:function(timeTag){this.outlets[0].message(utils.timeTag(["bang"],timeTag))},_metroTickRateChange:function(timeTag){this._metroTick=this._metroTickNormal;this._restartMetroTick(timeTag)}});library["delay"]=library["del"]=PdObject.extend({type:"delay",inletDefs:[portlets.Inlet.extend({message:function(args){var msg=args[0];if(msg==="bang"){this.obj._stopDelay();this.obj._startDelay(utils.getTimeTag(args))}else if(msg==="stop"){this.obj._stopDelay()}else{this.obj.setDelay(msg);this.obj._stopDelay();this.obj._startDelay(utils.getTimeTag(args))}}}),portlets.Inlet.extend({message:function(args){var delay=args[0];this.obj.setDelay(delay)}})],outletDefs:[portlets.Outlet],init:function(args){var delay=args[0];this.setDelay(delay||0);this._delayHandle=null},setDelay:function(delay){if(!_.isNumber(delay))return console.error("invalid [delay] length "+delay);this.delay=delay},destroy:function(){this._stopDelay()},_startDelay:function(timeTag){var self=this;if(this._delayHandle===null){this._delayHandle=pdGlob.clock.schedule(function(){self.outlets[0].message(["bang"])},timeTag+this.delay)}},_stopDelay:function(){if(this._delayHandle!==null){pdGlob.clock.unschedule(this._delayHandle);this._delayHandle=null}}});library["timer"]=PdObject.extend({type:"timer",inletDefs:[portlets.Inlet.extend({message:function(args){var msg=args[0];if(msg!=="bang")return console.error("invalid command for [timer] "+msg);this.obj.refTime=utils.getTimeTag(args)}}),portlets.Inlet.extend({message:function(args){var msg=args[0];if(msg!=="bang")return console.error("invalid command for [timer] "+msg);this.obj.outlets[0].message(utils.timeTag([utils.getTimeTag(args)-this.obj.refTime],args))}})],outletDefs:[portlets.Outlet],init:function(){this.refTime=0}});library["change"]=PdObject.extend({type:"change",inletDefs:[portlets.Inlet.extend({message:function(args){var val=args[0];if(val!==this.obj.last){this.obj.last=val;this.obj.o(0).message(utils.timeTag([val],args))}}})],outletDefs:[portlets.Outlet],init:function(){this.last=null}});library["array"]=library["table"]=PdObject.extend(mixins.NamedMixin,mixins.EventEmitterMixin,{type:"array",nameIsUnique:true,init:function(args){var name=args[0],size=args[1]||100;if(name)this.setName(name);this.size=size;this.data=new Float32Array(size)},destroy:function(){mixins.NamedMixin.destroy.apply(this,arguments);mixins.EventEmitterMixin.destroy.apply(this,arguments)},setData:function(audioData,resize){if(resize)this.data=new Float32Array(audioData.length);this.data.set(audioData.subarray(0,Math.min(this.data.length,audioData.length)));this.size=this.data.length;this.emit("changed:data")}});library["soundfiler"]=PdObject.extend({type:"soundfiler",inletDefs:[portlets.Inlet.extend({message:function(args){var self=this,command=args[0],doResize=false,arg,url,arrayNames;args=args.slice(1);if(command==="read"){while(args.length&&args[0][0]==="-"){arg=args.shift();if(arg==="-resize")doResize=true;else if(arg==="-wave"&&arg==="-aiff"&&arg==="-nextstep"&&arg==="-raw"&&arg==="-bytes"&&arg==="-nframes")return console.error(arg+" not supported");else return console.error(arg+" not understood")}url=args.shift();arrayNames=args;pdGlob.storage.get(url,function(err,arrayBuffer){if(err)return console.error("could not load file : "+err);pdGlob.audio.decode(arrayBuffer,function(err,audioData){if(err)return console.error("Could not decode file : "+err);var array,arrays,channelData;arrays=arrayNames.map(function(arrayName){array=pdGlob.namedObjects.get("array",arrayName)[0];if(!array){console.error('array "'+arrayName+'" not found');return null}else return array});if(_.contains(arrays,null))return;if(_.uniq(_.pluck(arrays,"size")).length!==1)doResize=true;arrays.forEach(function(array,i){channelData=audioData[i];if(!channelData)return;array.setData(channelData,doResize)});self.obj.o(0).message([Math.min(arrays[0].size,audioData[0].length)])})})}else console.error('command "'+command+'" is not supported')}})],outletDefs:[portlets.Outlet]});library["pd"]=library["graph"]=Patch}},{"./core/Patch":5,"./core/PdObject":6,"./core/mixins":9,"./core/utils":11,"./global":12,"./waa/portlets":17,underscore:24}],14:[function(require,module,exports){var _=require("underscore");exports.declareObjects=function(library){require("./glue").declareObjects(library);require("./controls").declareObjects(library);require("./waa/dsp").declareObjects(library);require("./waa/portlets").declareObjects(library)}},{"./controls":2,"./glue":13,"./waa/dsp":15,"./waa/portlets":17,underscore:24}],15:[function(require,module,exports){var _=require("underscore"),WAAOffset=require("waaoffsetnode"),WAAWhiteNoise=require("waawhitenoisenode"),WAATableNode=require("waatablenode"),utils=require("../core/utils"),mixins=require("../core/mixins"),PdObject=require("../core/PdObject"),portlets=require("./portlets"),pdGlob=require("../global");exports.declareObjects=function(library){var _OscBase=PdObject.extend({inletDefs:[portlets.DspInlet.extend({message:function(args){var frequency=args[0];if(!this.hasDspSource()){if(!_.isNumber(frequency))return console.error("invalid ["+this.obj.type+"] frequency "+frequency);if(frequency===Infinity)frequency=0;this.obj.frequency=frequency;this.obj._updateFrequency(utils.getTimeTag(args))}}}),portlets.Inlet.extend({message:function(args){var phase=args[0];if(!_.isNumber(phase))return console.error("invalid ["+this.obj.type+"] phase "+phase);this.obj._updatePhase(phase,utils.getTimeTag(args))}})],outletDefs:[portlets.DspOutlet],init:function(args){this.frequency=args[0]||0},start:function(){this._createOscillator(0,0)},stop:function(){this._destroyOscillator()},_updateFrequency:function(timeTag){if(this._oscNode)this._oscNode.frequency.setValueAtTime(this.frequency,timeTag/1e3)},_updatePhase:function(phase,timeTag){if(pdGlob.isStarted)this._createOscillator(phase,timeTag)}});library["osc~"]=_OscBase.extend({type:"osc~",_createOscillator:function(phase,timeTag){phase=phase*2*Math.PI;this._oscNode=pdGlob.audio.context.createOscillator();this._oscNode.setPeriodicWave(pdGlob.audio.context.createPeriodicWave(new Float32Array([0,Math.cos(phase)]),new Float32Array([0,Math.sin(-phase)])));this._oscNode.start(timeTag/1e3);this.o(0).setWaa(this._oscNode,0);this.i(0).setWaa(this._oscNode.frequency,0);this.i(0).message([this.frequency])},_destroyOscillator:function(){this._oscNode.stop(0);this._oscNode=null}});library["phasor~"]=_OscBase.extend({type:"phasor~",_createOscillator:function(phase,timeTag){this._gainNode=pdGlob.audio.context.createGain();this._gainNode.gain.value=.5;this._oscNode=pdGlob.audio.context.createOscillator();this._oscNode.type="sawtooth";this._oscNode.start(timeTag/1e3);this._oscNode.connect(this._gainNode);this._offsetNode=new WAAOffset(pdGlob.audio.context);this._offsetNode.offset.value=1;this._offsetNode.connect(this._gainNode);this.o(0).setWaa(this._gainNode,0);this.i(0).setWaa(this._oscNode.frequency,0);this.i(0).message([this.frequency])},_destroyOscillator:function(){this._oscNode.stop(0);this._oscNode=null;this._gainNode=null;this._offsetNode=null}});library["triangle~"]=_OscBase.extend({type:"triangle~",_createOscillator:function(phase,timeTag){this._oscNode=pdGlob.audio.context.createOscillator();this._oscNode.type="triangle";this._oscNode.start(timeTag/1e3);this.o(0).setWaa(this._oscNode,0);this.i(0).setWaa(this._oscNode.frequency,0);this.i(0).message([this.frequency])},_destroyOscillator:function(){this._oscNode.stop(0);this._oscNode=null}});library["square~"]=_OscBase.extend({type:"square~",_createOscillator:function(phase,timeTag){this._oscNode=pdGlob.audio.context.createOscillator();this._oscNode.type="square";this._oscNode.start(timeTag/1e3);this.o(0).setWaa(this._oscNode,0);this.i(0).setWaa(this._oscNode.frequency,0);this.i(0).message([this.frequency])},_destroyOscillator:function(){this._oscNode.stop(0);this._oscNode=null}});library["noise~"]=PdObject.extend({type:"noise~",outletDefs:[portlets.DspOutlet],start:function(){this._noiseNode=new WAAWhiteNoise(pdGlob.audio.context);this._noiseNode.start(0);this.o(0).setWaa(this._noiseNode,0)},stop:function(){this._noiseNode.stop(0);this._noiseNode.disconnect();this._noiseNode=null}});library["line~"]=PdObject.extend({type:"line~",inletDefs:[portlets.Inlet.extend({init:function(){this._queue=[];this._lastValue=0},message:function(args){var self=this;if(this.obj._offsetNode){var v2=args[0],t1=utils.getTimeTag(args),duration=args[1]||0;if(!_.isNumber(v2))return console.error("invalid [line~] value "+v2);if(duration){if(!_.isNumber(duration))return console.error("invalid [line~] duration "+duration)}this._refreshQueue(pdGlob.audio.time);var newLines=this._pushToQueue(t1,v2,duration);this.obj._offsetNode.offset.cancelScheduledValues(newLines[0].t1/1e3+1e-6);newLines.forEach(function(line){if(line.t1!==line.t2)self.obj._offsetNode.offset.linearRampToValueAtTime(line.v2,line.t2/1e3);else self.obj._offsetNode.offset.setValueAtTime(line.v2,line.t2/1e3)})}},_interpolate:function(line,time){return(time-line.t1)*(line.v2-line.v1)/(line.t2-line.t1)+line.v1},_refreshQueue:function(time){if(this._queue.length===0)return;var i=0,line,oldLines;while((line=this._queue[i++])&&time>=line.t2)1;oldLines=this._queue.slice(0,i-1);this._queue=this._queue.slice(i-1);if(this._queue.length===0)this._lastValue=oldLines[oldLines.length-1].v2},_pushToQueue:function(t1,v2,duration){var i=0,line,newLines=[];while((line=this._queue[i++])&&t1>=line.t2)1;this._queue=this._queue.slice(0);if(this._queue.length){var lastLine=this._queue[this._queue.length-1];if(t1<lastLine.t2){this._queue=this._queue.slice(0,-1);line={t1:lastLine.t1,v1:lastLine.v1,t2:t1,v2:this._interpolate(lastLine,t1)};newLines.push(line);this._queue.push(line)}else if(t1>lastLine.t2){line={t1:lastLine.t2,v1:lastLine.v2,t2:t1,v2:lastLine.v2};newLines.push(line);this._queue.push(line)}}else{line={t1:0,v1:this._lastValue,t2:t1,v2:this._lastValue};newLines.push(line);this._queue.push(line)}line={t1:t1,v1:this._queue[this._queue.length-1].v2,t2:t1+duration,v2:v2};newLines.push(line);this._queue.push(line);return newLines}})],outletDefs:[portlets.DspOutlet],start:function(){this._offsetNode=new WAAOffset(pdGlob.audio.context);this._offsetNode.offset.setValueAtTime(0,0);this.o(0).setWaa(this._offsetNode,0)},stop:function(){this._offsetNode=null}});library["sig~"]=PdObject.extend({type:"sig~",inletDefs:[portlets.Inlet.extend({message:function(args){var value=args[0];if(!_.isNumber(value))return console.error("invalid [sig~] value "+value);this.obj.value=value;if(this.obj._offsetNode)this.obj._offsetNode.offset.setValueAtTime(value,utils.getTimeTag(args)/1e3)}})],outletDefs:[portlets.DspOutlet],init:function(args){this.value=args[0]||0},start:function(){this._offsetNode=new WAAOffset(pdGlob.audio.context);this._offsetNode.offset.setValueAtTime(0,0);this.o(0).setWaa(this._offsetNode,0);this.i(0).message([this.value])},stop:function(){this._offsetNode=null}});var _FilterFrequencyInletMixin={message:function(args){var frequency=args[0];if(!_.isNumber(frequency))return console.error("invalid ["+this.obj.type+"] frequency "+frequency);this.obj.frequency=frequency;if(this.obj._filterNode)this.obj._filterNode.frequency.setValueAtTime(frequency,utils.getTimeTag(args)/1e3)}};var _FilterQInletMixin={message:function(args){var Q=args[0];if(!_.isNumber(Q))return console.error("invalid ["+this.obj.type+"] Q "+Q);this.obj.Q=Q;if(this.obj._filterNode)this.obj._filterNode.Q.setValueAtTime(Q,utils.getTimeTag(args)/1e3)}};var _BaseFilter=PdObject.extend({inletDefs:[portlets.DspInlet,portlets.Inlet.extend(_FilterFrequencyInletMixin)],outletDefs:[portlets.DspOutlet],init:function(args){this.frequency=args[0]||0},start:function(){this._filterNode=pdGlob.audio.context.createBiquadFilter();this._filterNode.frequency.setValueAtTime(this.frequency,0);this._filterNode.type=this.waaFilterType;this.i(0).setWaa(this._filterNode,0);this.o(0).setWaa(this._filterNode,0);this.i(1).message([this.frequency])},stop:function(){this._filterNode=null}});var _BaseBandFilter=_BaseFilter.extend({waaFilterType:"bandpass",init:function(args){_BaseFilter.prototype.init.call(this,args);this.Q=args[1]||1},start:function(args){_BaseFilter.prototype.start.call(this,args);this._filterNode.Q.setValueAtTime(this.Q,0);this.i(2).message([this.Q])}});library["lop~"]=_BaseFilter.extend({type:"lop~",waaFilterType:"lowpass"});library["hip~"]=_BaseFilter.extend({type:"hip~",waaFilterType:"highpass"});library["bp~"]=_BaseBandFilter.extend({type:"bp~",inletDefs:[portlets.DspInlet,portlets.Inlet.extend(_FilterFrequencyInletMixin),portlets.Inlet.extend(_FilterQInletMixin)]});library["vcf~"]=_BaseBandFilter.extend({type:"vcf~",inletDefs:[portlets.DspInlet,portlets.DspInlet.extend(_FilterFrequencyInletMixin),portlets.Inlet.extend(_FilterQInletMixin)],start:function(args){_BaseBandFilter.prototype.start.call(this,args);this.i(1).setWaa(this._filterNode.frequency,0)}});var _DspArithmBase=PdObject.extend({outletDefs:[portlets.DspOutlet],init:function(args){var val=args[0];this.setVal(val||0)},setVal:function(val){if(!_.isNumber(val))return console.error("invalid ["+this.obj.type+"] value "+val);this.val=val}});var _DspArithmValInletMixin={message:function(args){var val=args[0];this.obj.setVal(val);if(!this.hasDspSource())this._setValNoDsp(val,utils.getTimeTag(args))},disconnection:function(outlet){portlets.DspInlet.prototype.disconnection.apply(this,arguments);if(outlet instanceof portlets.DspOutlet&&!this.hasDspSource())this._setValNoDsp(this.obj.val,0)}};library["*~"]=_DspArithmBase.extend({type:"*~",inletDefs:[portlets.DspInlet,portlets.DspInlet.extend(_DspArithmValInletMixin,{_setValNoDsp:function(val,timeTag){if(this.obj._gainNode)this.obj._gainNode.gain.setValueAtTime(val,timeTag/1e3)}})],start:function(){this._gainNode=pdGlob.audio.context.createGain();this.i(0).setWaa(this._gainNode,0);this.i(1).setWaa(this._gainNode.gain,0);this.o(0).setWaa(this._gainNode,0);if(!this.i(1).hasDspSource())this.i(1)._setValNoDsp(this.val,0)},stop:function(){this._gainNode=null}});library["+~"]=_DspArithmBase.extend({type:"+~",inletDefs:[portlets.DspInlet,portlets.DspInlet.extend(_DspArithmValInletMixin,{_setValNoDsp:function(val,timeTag){if(this.obj._offsetNode)this.obj._offsetNode.offset.setValueAtTime(val,timeTag/1e3)}})],start:function(){this._offsetNode=new WAAOffset(pdGlob.audio.context);this._gainNode=pdGlob.audio.context.createGain();this._gainNode.gain.value=1;this._offsetNode.offset.value=0;this._offsetNode.connect(this._gainNode,0,0);this.i(0).setWaa(this._gainNode,0);this.i(1).setWaa(this._offsetNode.offset,0);this.o(0).setWaa(this._gainNode,0);if(!this.i(1).hasDspSource())this.i(1)._setValNoDsp(this.val,0)},stop:function(){this._offsetNode.disconnect();this._gainNode=null;this._offsetNode=null}});library["-~"]=_DspArithmBase.extend({type:"-~",inletDefs:[portlets.DspInlet,portlets.DspInlet.extend(_DspArithmValInletMixin,{_setValNoDsp:function(val,timeTag){if(this.obj._offsetNode)this.obj._offsetNode.offset.setValueAtTime(val,timeTag/1e3)}})],start:function(){this._offsetNode=new WAAOffset(pdGlob.audio.context);this._gainNode=pdGlob.audio.context.createGain();this._negateGainNode=pdGlob.audio.context.createGain();this._gainNode.gain.value=1;this._negateGainNode.gain.value=-1;this._offsetNode.offset.value=0;this._offsetNode.connect(this._negateGainNode,0,0);this._negateGainNode.connect(this._gainNode,0,0);this.i(0).setWaa(this._gainNode,0);this.i(1).setWaa(this._offsetNode.offset,0);this.o(0).setWaa(this._gainNode,0);if(!this.i(1).hasDspSource())this.i(1)._setValNoDsp(this.val,0)},stop:function(){this._negateGainNode.disconnect();this._offsetNode.disconnect();this._gainNode=null;this._negateGainNode=null;this._offsetNode=null}});var _TabBase=PdObject.extend({init:function(args){var self=this;this.array=new mixins.Reference("array");this._onDataChangedHandler=null;this._eventReceiver=new mixins.EventReceiver;this._eventReceiver.on(this.array,"changed",function(newArray,oldArray){if(oldArray)oldArray.removeListener("changed:data",self._onDataChangedHandler);if(newArray){self._onDataChangedHandler=function(){self.dataChanged()};self._eventReceiver.on(newArray,"changed:data",self._onDataChangedHandler)}})},dataChanged:function(){},destroy:function(){this._eventReceiver.destroy();this.array.destroy()}});library["tabread~"]=library["tabread4~"]=_TabBase.extend({type:"tabread~",inletDefs:[portlets.DspInlet.extend({message:function(args){var method=args[0];if(method==="set")this.obj.array.set(args[1]);else console.error("unknown method "+method)},connection:function(){portlets.DspInlet.prototype.connection.apply(this,arguments);this.obj._updateDsp()},disconnection:function(){portlets.DspInlet.prototype.disconnection.apply(this,arguments);this.obj._updateDsp()}})],outletDefs:[portlets.DspOutlet],init:function(args){var self=this,arrayName=args[0];_TabBase.prototype.init.apply(this,arguments);this._eventReceiver.on(this.array,"changed",function(){self._updateDsp()});if(arrayName)this.array.set(arrayName)},start:function(){this._tableNode=new WAATableNode(pdGlob.audio.context);this._gainNode=pdGlob.audio.context.createGain();this.i(0).setWaa(this._tableNode.position,0);this.o(0).setWaa(this._gainNode,0);this._updateDsp()},stop:function(){this._tableNode=null;this._gainNode=null},dataChanged:function(){if(this._tableNode)this._tableNode.table=this.array.resolved.data},_updateDsp:function(){if(this._tableNode&&this.array.resolved&&this.i(0).hasDspSource()){this._tableNode.table=this.array.resolved.data;this._tableNode.connect(this._gainNode)}else if(this._tableNode){this._tableNode.disconnect()}}});library["delwrite~"]=PdObject.extend(mixins.NamedMixin,mixins.EventEmitterMixin,{type:"delwrite~",inletDefs:[portlets.DspInlet],init:function(args){var name=args[0],maxDelayTime=args[1];this.maxDelayTime=maxDelayTime||1e3;if(name)this.setName(name)},start:function(){this._pipeNode=pdGlob.audio.context.createGain();this.i(0).setWaa(this._pipeNode,0);this.emit("started")},stop:function(){this._pipeNode.disconnect();this._pipeNode=null},destroy:function(){mixins.NamedMixin.destroy.apply(this,arguments);mixins.EventEmitterMixin.destroy.apply(this,arguments)}});library["delread~"]=library["vd~"]=PdObject.extend({type:"delread~",inletDefs:[portlets.DspInlet.extend({message:function(args){var delayTime=args[0];this.obj.setDelayTime(delayTime,utils.getTimeTag(args))}})],outletDefs:[portlets.DspOutlet],init:function(args){var self=this,delayName=args[0],initialDelayTime=args[1];this._eventReceiver=new mixins.EventReceiver;this._delayTime=initialDelayTime||0;this._delWrite=new mixins.Reference("delwrite~");this._onDelWriteStarted=null;if(delayName)this._delWrite.set(delayName)},start:function(){this._createDelay();this._onDelWriteChanged=function(newObj,oldObj){if(pdGlob.isStarted&&newObj)self._createDelay()};this._eventReceiver.on(this._delWrite,"changed",this._onDelWriteChanged)},stop:function(){this._toSecondsGain=null;this._delayNode.disconnect();this._delayNode=null;this._delWrite.removeListener("changed",this._onDelWriteChanged);this._onDelWriteChanged=null},destroy:function(){this._delWrite.destroy();this._eventReceiver.destroy()},setDelayTime:function(delayTime,timeTag){if(!_.isNumber(delayTime))return console.error("invalid [delread~] length "+delayTime);this._delayTime=delayTime;if(this._delayNode&&!this.i(0).hasDspSource())this._delayNode.delayTime.setValueAtTime(this._delayTime/1e3,timeTag/1e3||0)},_createDelay:function(){if(this._delayNode)this._delayNode.disconnect();var maxDelayTime=this._delWrite.resolved?this._delWrite.resolved.maxDelayTime/1e3:1,self=this;this._delayNode=pdGlob.audio.context.createDelay(maxDelayTime);if(!this._toSecondsGain){this._toSecondsGain=pdGlob.audio.context.createGain();this._toSecondsGain.gain.value=.001;this.i(0).setWaa(this._toSecondsGain,0)}this._toSecondsGain.connect(this._delayNode.delayTime);this.o(0).setWaa(this._delayNode,0);this.setDelayTime(this._delayTime);if(this._delWrite.resolved){var doConnection=function(){self._delWrite.resolved._pipeNode.connect(self._delayNode)};if(this._delWrite.resolved._pipeNode)doConnection();else{this._onDelWriteStarted=doConnection;this._eventReceiver.once(this._delWrite.resolved,"started",this._onDelWriteStarted)}}}});library["clip~"]=PdObject.extend({type:"clip~",inletDefs:[portlets.DspInlet,portlets.Inlet.extend({message:function(args){var minValue=args[0];if(!_.isNumber(minValue))return console.error("invalid [clip~] min "+minValue);this.obj.minValue=minValue;this.obj._updateGains()}}),portlets.Inlet.extend({message:function(args){var maxValue=args[0];if(!_.isNumber(maxValue))return console.error("invalid [clip~] max "+maxValue);this.obj.maxValue=maxValue;this.obj._updateGains()}})],outletDefs:[portlets.DspOutlet],init:function(args){this.minValue=args[0]||0;this.maxValue=args[1]||0},start:function(){this._gainInNode=pdGlob.audio.context.createGain();this._gainOutNode=pdGlob.audio.context.createGain();

this._waveShaperNode=pdGlob.audio.context.createWaveShaper();this._gainInNode.connect(this._waveShaperNode);this.i(0).setWaa(this._gainInNode,0);this.o(0).setWaa(this._waveShaperNode,0);this._updateGains()},stop:function(){this._gainInNode=null;this._waveShaperNode=null;this._gainOutNode.disconnect();this._gainOutNode=null},_updateGains:function(){if(this._waveShaperNode){var bound=Math.max(Math.abs(this.minValue),Math.abs(this.maxValue)),sampleRate=pdGlob.audio.sampleRate,curve=new Float32Array(sampleRate),i,acc=-bound,k=bound*2/sampleRate;for(i=0;i<sampleRate;i++){if(acc>=this.minValue&&acc<=this.maxValue)curve[i]=acc;else if(acc>this.maxValue)curve[i]=this.maxValue;else curve[i]=this.minValue;acc+=k}this._waveShaperNode.curve=curve;this._gainInNode.gain.setValueAtTime(bound!==0?1/bound:0,0)}}});library["dac~"]=PdObject.extend({type:"dac~",endPoint:true,inletDefs:[portlets.DspInlet,portlets.DspInlet],start:function(){this.i(0).setWaa(pdGlob.audio.channels[0],0);this.i(1).setWaa(pdGlob.audio.channels[1],0)}});library["adc~"]=PdObject.extend({type:"adc~",outletDefs:[portlets.DspOutlet,portlets.DspOutlet],init:function(){this.stream=null},start:function(){var self=this;if(this.stream)this._updateSource();else{this.o(0).setWaa(pdGlob.audio.context.createGain(),0);this.o(1).setWaa(pdGlob.audio.context.createGain(),0);pdGlob.audio.getUserMedia(function(err,stream){if(err)return console.error("error obtaining mic input : "+err);self.stream=stream;if(pdGlob.isStarted)self._updateSource()})}},stop:function(){this._sourceNode.disconnect();this._sourceNode=null;this._splitterNode=null},_updateSource:function(){if(this.stream){this._sourceNode=pdGlob.audio.context.createMediaStreamSource(this.stream);this._splitterNode=pdGlob.audio.context.createChannelSplitter(2);this._sourceNode.connect(this._splitterNode);this.o(0).setWaa(this._splitterNode,0);this.o(1).setWaa(this._splitterNode,1)}}})}},{"../core/PdObject":6,"../core/mixins":9,"../core/utils":11,"../global":12,"./portlets":17,underscore:24,waaoffsetnode:30,waatablenode:32,waawhitenoisenode:34}],16:[function(require,module,exports){var _=require("underscore"),getUserMedia=require("getusermedia"),WAAClock=require("waaclock"),pdGlob=require("../global");var Audio=exports.Audio=function(opts){if(typeof AudioContext==="undefined")return console.error("this environment doesn't support Web Audio API");this.channelCount=opts.channelCount;this.setContext(opts.audioContext||new AudioContext);this.sampleRate=this.context.sampleRate;this.stream=null;Object.defineProperty(this,"time",{get:function(){return this.context.currentTime*1e3}})};Audio.prototype.start=function(){};Audio.prototype.stop=function(){};Audio.prototype.decode=function(arrayBuffer,done){this.context.decodeAudioData(arrayBuffer,function(audioBuffer){var chArrays=[],ch;for(ch=0;ch<audioBuffer.numberOfChannels;ch++)chArrays.push(audioBuffer.getChannelData(ch));done(null,chArrays)},function(err){done(new Error("error decoding "+err))})};Audio.prototype.getUserMedia=function(done){var self=this;if(this.stream)done(null,this.stream);else{getUserMedia({audio:{mandatory:{googEchoCancellation:false,googAutoGainControl:false,googNoiseSuppression:false,googTypingNoiseDetection:false}}},function(err,stream){self.stream=stream;done(err,stream)})}};Audio.prototype.setContext=function(context){var ch;this.context=context;this._channelMerger=this.context.createChannelMerger(this.channelCount);this._channelMerger.connect(this.context.destination);this.channels=[];for(ch=0;ch<this.channelCount;ch++){this.channels.push(this.context.createGain());this.channels[ch].connect(this._channelMerger,0,ch)}};var Clock=exports.Clock=function(opts){var self=this;this._audioContext=opts.audioContext;this._waaClock=opts.waaClock||new WAAClock(opts.audioContext);this._waaClock.start();Object.defineProperty(this,"time",{get:function(){return self._audioContext.currentTime*1e3}})};Clock.prototype.schedule=function(func,time,repetition){var _func=function(event){if(event.timeTag==undefined)event.timeTag=event.deadline*1e3;func(event)},event=this._waaClock.callbackAtTime(_func,time/1e3);Object.defineProperty(event,"timeTag",{get:function(){return this.deadline*1e3}});if(_.isNumber(repetition))event.repeat(repetition/1e3);return event};Clock.prototype.unschedule=function(event){event.clear()};var WebStorage=exports.Storage=function(){};WebStorage.prototype.get=function(url,done){var req=new XMLHttpRequest;req.onload=function(e){if(this.status===200)done(null,this.response);else done(new Error("HTTP "+this.status+": "+this.statusText))};req.onerror=function(e){done(e)};req.open("GET",url,true);req.responseType="arraybuffer";req.send()}},{"../global":12,getusermedia:19,underscore:24,waaclock:28}],17:[function(require,module,exports){var _=require("underscore"),WAAWire=require("waawire"),utils=require("../core/utils"),PdObject=require("../core/PdObject"),BaseInlet=require("../core/portlets").Inlet,BaseOutlet=require("../core/portlets").Outlet,pdGlob=require("../global"),AudioParam=typeof window!=="undefined"?window.AudioParam:function(){};var InletMixin={future:function(time,args){this.message(utils.timeTag(args,time))}};var Inlet=exports.Inlet=BaseInlet.extend(InletMixin);var Outlet=exports.Outlet=BaseOutlet.extend({message:function(args){this.connections.forEach(function(sink){sink.message(args)})}});var DspInlet=exports.DspInlet=BaseInlet.extend(InletMixin,{hasDspSource:function(){return _.filter(this.connections,function(outlet){return outlet instanceof DspOutlet}).length>0},init:function(){this._started=false},start:function(){this._started=true},stop:function(){this._waa=null;this._started=false},setWaa:function(node,input){var self=this;this._waa={node:node,input:input};if(node instanceof AudioParam)node.setValueAtTime(0,0);if(this._started){_.chain(this.connections).filter(function(outlet){return outlet instanceof DspOutlet}).forEach(function(outlet){outlet._waaUpdate(self)}).value()}}});var DspOutlet=exports.DspOutlet=BaseOutlet.extend({init:function(){this._waaConnections={};this._started=false},start:function(){this._started=true;this.connections.forEach(this._waaConnect.bind(this))},stop:function(){this._started=false;this.connections.forEach(this._waaDisconnect.bind(this));this._waaConnections={}},connection:function(inlet){if(!(inlet instanceof DspInlet))throw new Error("can only connect to DSP inlet");if(this._started)this._waaConnect(inlet)},disconnection:function(inlet){if(this._started)this._waaDisconnect(inlet)},message:function(){throw new Error("dsp outlet received a message")},setWaa:function(node,output){var self=this;this._waa={node:node,output:output};if(this._started){_.values(this._waaConnections).forEach(function(connector){connector.swapSource(node,output)})}},_waaConnect:function(inlet){var connector=new WAAWire(pdGlob.audio.context);this._waaConnections[this._getConnectionId(inlet)]=connector;connector.connect(this._waa.node,inlet._waa.node,this._waa.output,inlet._waa.input)},_waaDisconnect:function(inlet){var connector=this._waaConnections[this._getConnectionId(inlet)];delete this._waaConnections[this._getConnectionId(inlet)];connector.close()},_waaUpdate:function(inlet){this._waaConnections[this._getConnectionId(inlet)].swapDestination(inlet._waa.node,inlet._waa.input)},_getConnectionId:function(inlet){return inlet.obj.id+":"+inlet.id}});exports.declareObjects=function(library){var InletInlet=Inlet.extend({message:function(args){this.obj.outlets[0].message(args)}});var InletInletDsp=DspInlet.extend({message:function(args){this.obj.outlets[0].message(args)}});var OutletOutletDsp=DspOutlet.extend({stop:function(){DspOutlet.prototype.stop.apply(this,arguments);if(this._outNodeConnector)this._outNodeConnector.close();this._outNodeConnector=null;if(this._outNode)this._outNode.disconnect();this._outNode=null},setWaa:function(node,output){if(this._outNodeConnector)this._outNodeConnector.close();if(!this._outNode)this._outNode=pdGlob.audio.context.createGain();DspOutlet.prototype.setWaa.apply(this,arguments);this._outNodeConnector=new WAAWire(pdGlob.audio.context);this._outNodeConnector.connect(this._waa.node,this._outNode,this._waa.output,0)},getOutNode:function(){return this._outNode},message:function(args){this.sinks.forEach(function(sink){sink.message(args)})}});var PortletDspObjectMixin={start:function(){this._gainNode=pdGlob.audio.context.createGain();this._gainNode.gain.value=1;this.i(0).setWaa(this._gainNode,0);this.o(0).setWaa(this._gainNode,0)},stop:function(){this._gainNode=null}};library["outlet"]=PdObject.extend({type:"outlet",inletDefs:[InletInlet],outletDefs:[Outlet.extend({crossPatch:true})]});library["inlet"]=PdObject.extend({type:"inlet",inletDefs:[InletInlet.extend({crossPatch:true})],outletDefs:[Outlet]});library["outlet~"]=PdObject.extend(PortletDspObjectMixin,{type:"outlet~",inletDefs:[InletInletDsp],outletDefs:[OutletOutletDsp.extend({crossPatch:true})]});library["inlet~"]=PdObject.extend(PortletDspObjectMixin,{type:"inlet~",inletDefs:[InletInletDsp.extend({crossPatch:true})],outletDefs:[OutletOutletDsp]})}},{"../core/PdObject":6,"../core/portlets":10,"../core/utils":11,"../global":12,underscore:24,waawire:36}],18:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}throw TypeError('Uncaught, unspecified "error" event.')}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}}else if(isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){var m;if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else{while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],19:[function(require,module,exports){var adapter=require("webrtc-adapter");module.exports=function(constraints,cb){var error;var haveOpts=arguments.length===2;var defaultOpts={video:true,audio:true};var denied="PermissionDeniedError";var altDenied="PERMISSION_DENIED";var notSatisfied="ConstraintNotSatisfiedError";if(!haveOpts){cb=constraints;constraints=defaultOpts}if(typeof navigator==="undefined"||!navigator.getUserMedia){error=new Error("MediaStreamError");error.name="NotSupportedError";return setTimeout(function(){cb(error)},0)}if(!constraints.audio&&!constraints.video){error=new Error("MediaStreamError");error.name="NoMediaRequestedError";return setTimeout(function(){cb(error)},0)}if(localStorage&&localStorage.useFirefoxFakeDevice==="true"){constraints.fake=true}navigator.mediaDevices.getUserMedia(constraints).then(function(stream){cb(null,stream)}).catch(function(err){var error;if(typeof err==="string"){error=new Error("MediaStreamError");if(err===denied||err===altDenied){error.name=denied}else{error.name=notSatisfied}}else{error=err;if(!error.name){if(error[denied]){err.name=denied}else{err.name=notSatisfied}}}cb(error)})}},{"webrtc-adapter":38}],20:[function(require,module,exports){var _=require("underscore"),NODES=["obj","floatatom","symbolatom","msg","text"],tokensRe=/ |\r\n?|\n/,afterCommaRe=/,(?!\\)/,escapedDollarVarReGlob=/\\(\$\d+)/g,escapedCommaVarReGlob=/\\\,/g,escapedSemicolonVarReGlob=/\\\;/g,linesRe=/(#((.|\r|\n)*?)[^\\\\])\r{0,1}\n{0,1};\r{0,1}(\n|$)/i;var _reverseString=function(s){return s.split("").reverse().join("")};var parseArg=exports.parseArg=function(arg){var parsed=pdParseFloat(arg);if(_.isNumber(parsed)&&!isNaN(parsed))return parsed;else if(_.isString(arg)){var matched,arg=arg.substr(0);arg=arg.replace(escapedCommaVarReGlob,",");arg=arg.replace(escapedSemicolonVarReGlob,";");while(matched=escapedDollarVarReGlob.exec(arg)){arg=arg.replace(matched[0],matched[1])}return arg}else throw new Error("couldn't parse arg "+arg)};var pdParseFloat=exports.parseFloat=function(data){if(_.isNumber(data)&&!isNaN(data))return data;else if(_.isString(data))return parseFloat(data);else return NaN};var parseArgs=exports.parseArgs=function(args){if(_.isNumber(args)&&!isNaN(args))return[args];else{var parts=_.isString(args)?args.split(tokensRe):args,parsed=[],arg,i,length;for(i=0,length=parts.length;i<length;i++){if((arg=parts[i])==="")continue;else parsed.push(parseArg(arg))}return parsed}};exports.parse=function(txt){return recursParse(txt)[0]};var recursParse=function(txt){var currentTable=null,idCounter=-1,nextId=function(){idCounter++;return idCounter},patch={nodes:[],connections:[],layout:undefined,args:[]},line,firstLine=true,nextLine=function(){txt=txt.slice(line.index+line[0].length)};linesRe.lastIndex=0;while(line=txt.match(linesRe)){var lineParts=_reverseString(line[1]).split(afterCommaRe).reverse().map(_reverseString),lineAfterComma=lineParts[1],tokens=lineParts[0].split(tokensRe),chunkType=tokens[0];if(chunkType==="#N"){var elementType=tokens[1];if(elementType==="canvas"){if(!firstLine){var result=recursParse(txt),subpatch=result[0],attrs=result[2];patch.nodes.push(_.extend({id:nextId(),subpatch:subpatch},attrs));txt=result[1]}else{patch.layout={x:parseInt(tokens[2],10),y:parseInt(tokens[3],10),width:parseInt(tokens[4],10),height:parseInt(tokens[5],10),openOnLoad:tokens[7]};patch.args=[tokens[6]];nextLine()}}else throw new Error("invalid element type for chunk #N : "+elementType)}else if(chunkType==="#X"){var elementType=tokens[1];if(elementType==="restore"){var layout={x:parseInt(tokens[2],10),y:parseInt(tokens[3],10)},canvasType=tokens[4],args=[];if(canvasType==="pd")args.push(tokens[5]);if(currentTable){var tableSize=currentTable.args[1];while(currentTable.data.length<tableSize)currentTable.data.push(0);currentTable=null}nextLine();return[patch,txt,{proto:canvasType,args:args,layout:layout}]}else if(_.contains(NODES,elementType)){var proto,args,layout={x:parseInt(tokens[2],10),y:parseInt(tokens[3],10)},result;if(elementType==="obj"){proto=tokens[4];args=tokens.slice(5)}else{proto=elementType;args=tokens.slice(4)}if(elementType==="text")args=[tokens.slice(4).join(" ")];result=parseControls(proto,args,layout);args=result[0];layout=result[1];if(lineAfterComma){var afterCommaTokens=lineAfterComma.split(tokensRe);while(afterCommaTokens.length){var command=afterCommaTokens.shift();if(command==="f")layout.width=afterCommaTokens.shift()}}patch.nodes.push({id:nextId(),proto:proto,layout:layout,args:parseArgs(args)})}else if(elementType==="array"){var arrayName=tokens[2],arraySize=parseFloat(tokens[3]),table={id:nextId(),proto:"table",args:[arrayName,arraySize],data:[]};patch.nodes.push(table);currentTable=table}else if(elementType==="connect"){var sourceId=parseInt(tokens[2],10),sinkId=parseInt(tokens[4],10),sourceOutlet=parseInt(tokens[3],10),sinkInlet=parseInt(tokens[5],10);patch.connections.push({source:{id:sourceId,port:sourceOutlet},sink:{id:sinkId,port:sinkInlet}})}else if(elementType==="coords"){}else throw new Error("invalid element type for chunk #X : "+elementType);nextLine()}else if(chunkType==="#A"){var idx=parseFloat(tokens[1]),t,length,val;if(currentTable){for(t=2,length=tokens.length;t<length;t++,idx++){val=parseFloat(tokens[t]);if(_.isNumber(val)&&!isNaN(val))currentTable.data[idx]=val}}else{console.error("got table data outside of a table.")}nextLine()}else throw new Error("invalid chunk : "+chunkType);firstLine=false}return[patch,""]};var parseControls=function(proto,args,layout){if(proto==="floatatom"){layout.width=args[0];layout.labelPos=args[3];layout.label=args[4];args=[args[1],args[2],args[5],args[6]]}else if(proto==="symbolatom"){layout.width=args[0];layout.labelPos=args[3];layout.label=args[4];args=[args[1],args[2],args[5],args[6]]}else if(proto==="bng"){layout.size=args[0];layout.hold=args[1];layout.interrupt=args[2];layout.label=args[6];layout.labelX=args[7];layout.labelY=args[8];layout.labelFont=args[9];layout.labelFontSize=args[10];layout.bgColor=args[11];layout.fgColor=args[12];layout.labelColor=args[13];args=[args[3],args[4],args[5]]}else if(proto==="tgl"){layout.size=args[0];layout.label=args[4];layout.labelX=args[5];layout.labelY=args[6];layout.labelFont=args[7];layout.labelFontSize=args[8];layout.bgColor=args[9];layout.fgColor=args[10];layout.labelColor=args[11];args=[args[1],args[2],args[3],args[12],args[13]]}else if(proto==="nbx"){layout.size=args[0];layout.height=args[1];layout.log=args[4];layout.label=args[8];layout.labelX=args[9];layout.labelY=args[10];layout.labelFont=args[11];layout.labelFontSize=args[12];layout.bgColor=args[13];layout.fgColor=args[14];layout.labelColor=args[15];layout.logHeight=args[17];args=[args[2],args[3],args[5],args[6],args[7],args[16]]}else if(proto==="vsl"){layout.width=args[0];layout.height=args[1];layout.log=args[4];layout.label=args[8];layout.labelX=args[9];layout.labelY=args[10];layout.labelFont=args[11];layout.labelFontSize=args[12];layout.bgColor=args[13];layout.fgColor=args[14];layout.labelColor=args[15];layout.steadyOnClick=args[17];args=[args[2],args[3],args[5],args[6],args[7],args[2]+(args[3]-args[2])*args[16]/12700]}else if(proto==="hsl"){layout.width=args[0];layout.height=args[1];layout.log=args[4];layout.label=args[8];layout.labelX=args[9];layout.labelY=args[10];layout.labelFont=args[11];layout.labelFontSize=args[12];layout.bgColor=args[13];layout.fgColor=args[14];layout.labelColor=args[15];layout.steadyOnClick=args[17];args=[args[2],args[3],args[5],args[6],args[7],args[2]+(args[3]-args[2])*args[16]/12700]}else if(proto==="vradio"){layout.size=args[0];layout.label=args[6];layout.labelX=args[7];layout.labelY=args[8];layout.labelFont=args[9];layout.labelFontSize=args[10];layout.bgColor=args[11];layout.fgColor=args[12];layout.labelColor=args[13];args=[args[1],args[2],args[3],args[4],args[5],args[14]]}else if(proto==="hradio"){layout.size=args[0];layout.label=args[6];layout.labelX=args[7];layout.labelY=args[8];layout.labelFont=args[9];layout.labelFontSize=args[10];layout.bgColor=args[11];layout.fgColor=args[12];layout.labelColor=args[13];args=[args[1],args[2],args[3],args[4],args[5],args[14]]}else if(proto==="vu"){layout.width=args[0];layout.height=args[1];layout.label=args[3];layout.labelX=args[4];layout.labelY=args[5];layout.labelFont=args[6];layout.labelFontSize=args[7];layout.bgColor=args[8];layout.labelColor=args[9];layout.log=args[10];args=[args[2],args[11]]}else if(proto==="cnv"){layout.size=args[0];layout.width=args[1];layout.height=args[2];layout.label=args[5];layout.labelX=args[6];layout.labelY=args[7];layout.labelFont=args[8];layout.labelFontSize=args[9];layout.bgColor=args[10];layout.labelColor=args[11];args=[args[3],args[4],args[12]]}return[args,layout]}},{underscore:21}],21:[function(require,module,exports){(function(){var root=this;var previousUnderscore=root._;var breaker={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeForEach=ArrayProto.forEach,nativeMap=ArrayProto.map,nativeReduce=ArrayProto.reduce,nativeReduceRight=ArrayProto.reduceRight,nativeFilter=ArrayProto.filter,nativeEvery=ArrayProto.every,nativeSome=ArrayProto.some,nativeIndexOf=ArrayProto.indexOf,nativeLastIndexOf=ArrayProto.lastIndexOf,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.4.4";var each=_.each=_.forEach=function(obj,iterator,context){if(obj==null)return;if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context)}else if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(iterator.call(context,obj[i],i,obj)===breaker)return}}else{for(var key in obj){if(_.has(obj,key)){if(iterator.call(context,obj[key],key,obj)===breaker)return}}}};_.map=_.collect=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeMap&&obj.map===nativeMap)return obj.map(iterator,context);each(obj,function(value,index,list){results[results.length]=iterator.call(context,value,index,list)});return results};var reduceError="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduce&&obj.reduce===nativeReduce){if(context)iterator=_.bind(iterator,context);return initial?obj.reduce(iterator,memo):obj.reduce(iterator)}each(obj,function(value,index,list){if(!initial){memo=value;initial=true}else{memo=iterator.call(context,memo,value,index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.reduceRight=_.foldr=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduceRight&&obj.reduceRight===nativeReduceRight){if(context)iterator=_.bind(iterator,context);return initial?obj.reduceRight(iterator,memo):obj.reduceRight(iterator)}var length=obj.length;if(length!==+length){var keys=_.keys(obj);length=keys.length}each(obj,function(value,index,list){index=keys?keys[--length]:--length;if(!initial){memo=obj[index];initial=true}else{memo=iterator.call(context,memo,obj[index],index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.find=_.detect=function(obj,iterator,context){var result;any(obj,function(value,index,list){if(iterator.call(context,value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeFilter&&obj.filter===nativeFilter)return obj.filter(iterator,context);each(obj,function(value,index,list){if(iterator.call(context,value,index,list))results[results.length]=value});return results};_.reject=function(obj,iterator,context){return _.filter(obj,function(value,index,list){return!iterator.call(context,value,index,list)},context)};_.every=_.all=function(obj,iterator,context){iterator||(iterator=_.identity);var result=true;if(obj==null)return result;if(nativeEvery&&obj.every===nativeEvery)return obj.every(iterator,context);each(obj,function(value,index,list){if(!(result=result&&iterator.call(context,value,index,list)))return breaker});return!!result};var any=_.some=_.any=function(obj,iterator,context){iterator||(iterator=_.identity);var result=false;if(obj==null)return result;if(nativeSome&&obj.some===nativeSome)return obj.some(iterator,context);each(obj,function(value,index,list){if(result||(result=iterator.call(context,value,index,list)))return breaker});return!!result};_.contains=_.include=function(obj,target){if(obj==null)return false;if(nativeIndexOf&&obj.indexOf===nativeIndexOf)return obj.indexOf(target)!=-1;return any(obj,function(value){return value===target})};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,function(value){return value[key]})};_.where=function(obj,attrs,first){if(_.isEmpty(attrs))return first?null:[];return _[first?"find":"filter"](obj,function(value){for(var key in attrs){if(attrs[key]!==value[key])return false}return true})};_.findWhere=function(obj,attrs){return _.where(obj,attrs,true)};_.max=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.max.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return-Infinity;var result={computed:-Infinity,value:-Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed>=result.computed&&(result={value:value,computed:computed})});return result.value};_.min=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.min.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return Infinity;var result={computed:Infinity,value:Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed<result.computed&&(result={value:value,computed:computed})});return result.value};_.shuffle=function(obj){var rand;var index=0;var shuffled=[];each(obj,function(value){rand=_.random(index++);shuffled[index-1]=shuffled[rand];shuffled[rand]=value});return shuffled};var lookupIterator=function(value){return _.isFunction(value)?value:function(obj){return obj[value]}};_.sortBy=function(obj,value,context){var iterator=lookupIterator(value);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iterator.call(context,value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index<right.index?-1:1}),"value")};var group=function(obj,value,context,behavior){var result={};var iterator=lookupIterator(value||_.identity);each(obj,function(value,index){var key=iterator.call(context,value,index,obj);behavior(result,key,value)});return result};_.groupBy=function(obj,value,context){return group(obj,value,context,function(result,key,value){(_.has(result,key)?result[key]:result[key]=[]).push(value)})};_.countBy=function(obj,value,context){return group(obj,value,context,function(result,key){if(!_.has(result,key))result[key]=0;result[key]++})};_.sortedIndex=function(array,obj,iterator,context){iterator=iterator==null?_.identity:lookupIterator(iterator);var value=iterator.call(context,obj);var low=0,high=array.length;while(low<high){var mid=low+high>>>1;iterator.call(context,array[mid])<value?low=mid+1:high=mid}return low};_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(obj.length===+obj.length)return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return obj.length===+obj.length?obj.length:_.keys(obj).length};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;return n!=null&&!guard?slice.call(array,0,n):array[0]};_.initial=function(array,n,guard){return slice.call(array,0,array.length-(n==null||guard?1:n))};_.last=function(array,n,guard){if(array==null)return void 0;if(n!=null&&!guard){return slice.call(array,Math.max(array.length-n,0))}else{return array[array.length-1]}};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,output){each(input,function(value){if(_.isArray(value)){shallow?push.apply(output,value):flatten(value,shallow,output)}else{output.push(value)}});return output};_.flatten=function(array,shallow){return flatten(array,shallow,[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted,iterator,context){if(_.isFunction(isSorted)){context=iterator;iterator=isSorted;isSorted=false}var initial=iterator?_.map(array,iterator,context):array;var results=[];var seen=[];each(initial,function(value,index){if(isSorted?!index||seen[seen.length-1]!==value:!_.contains(seen,value)){seen.push(value);results.push(array[index])}});return results};_.union=function(){return _.uniq(concat.apply(ArrayProto,arguments))};_.intersection=function(array){var rest=slice.call(arguments,1);return _.filter(_.uniq(array),function(item){return _.every(rest,function(other){return _.indexOf(other,item)>=0})})};_.difference=function(array){var rest=concat.apply(ArrayProto,slice.call(arguments,1));return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(){var args=slice.call(arguments);var length=_.max(_.pluck(args,"length"));var results=new Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(args,""+i)}return results};_.object=function(list,values){if(list==null)return{};var result={};for(var i=0,l=list.length;i<l;i++){
if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,l=array.length;if(isSorted){if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,l+isSorted):isSorted}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1}}if(nativeIndexOf&&array.indexOf===nativeIndexOf)return array.indexOf(item,isSorted);for(;i<l;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var hasIndex=from!=null;if(nativeLastIndexOf&&array.lastIndexOf===nativeLastIndexOf){return hasIndex?array.lastIndexOf(item,from):array.lastIndexOf(item)}var i=hasIndex?from:array.length;while(i--)if(array[i]===item)return i;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=arguments[2]||1;var len=Math.max(Math.ceil((stop-start)/step),0);var idx=0;var range=new Array(len);while(idx<len){range[idx++]=start;start+=step}return range};_.bind=function(func,context){if(func.bind===nativeBind&&nativeBind)return nativeBind.apply(func,slice.call(arguments,1));var args=slice.call(arguments,2);return function(){return func.apply(context,args.concat(slice.call(arguments)))}};_.partial=function(func){var args=slice.call(arguments,1);return function(){return func.apply(this,args.concat(slice.call(arguments)))}};_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(funcs.length===0)funcs=_.functions(obj);each(funcs,function(f){obj[f]=_.bind(obj[f],obj)});return obj};_.memoize=function(func,hasher){var memo={};hasher||(hasher=_.identity);return function(){var key=hasher.apply(this,arguments);return _.has(memo,key)?memo[key]:memo[key]=func.apply(this,arguments)}};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};_.throttle=function(func,wait){var context,args,timeout,result;var previous=0;var later=function(){previous=new Date;timeout=null;result=func.apply(context,args)};return function(){var now=new Date;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args)}else if(!timeout){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,result;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate)result=func.apply(context,args)};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)result=func.apply(context,args);return result}};_.once=function(func){var ran=false,memo;return function(){if(ran)return memo;ran=true;memo=func.apply(this,arguments);func=null;return memo}};_.wrap=function(func,wrapper){return function(){var args=[func];push.apply(args,arguments);return wrapper.apply(this,args)}};_.compose=function(){var funcs=arguments;return function(){var args=arguments;for(var i=funcs.length-1;i>=0;i--){args=[funcs[i].apply(this,args)]}return args[0]}};_.after=function(times,func){if(times<=0)return func();return function(){if(--times<1){return func.apply(this,arguments)}}};_.keys=nativeKeys||function(obj){if(obj!==Object(obj))throw new TypeError("Invalid object");var keys=[];for(var key in obj)if(_.has(obj,key))keys[keys.length]=key;return keys};_.values=function(obj){var values=[];for(var key in obj)if(_.has(obj,key))values.push(obj[key]);return values};_.pairs=function(obj){var pairs=[];for(var key in obj)if(_.has(obj,key))pairs.push([key,obj[key]]);return pairs};_.invert=function(obj){var result={};for(var key in obj)if(_.has(obj,key))result[obj[key]]=key;return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){obj[prop]=source[prop]}}});return obj};_.pick=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));each(keys,function(key){if(key in obj)copy[key]=obj[key]});return copy};_.omit=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));for(var key in obj){if(!_.contains(keys,key))copy[key]=obj[key]}return copy};_.defaults=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){if(obj[prop]==null)obj[prop]=source[prop]}}});return obj};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!=toString.call(b))return false;switch(className){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return false;var length=aStack.length;while(length--){if(aStack[length]==a)return bStack[length]==b}aStack.push(a);bStack.push(b);var size=0,result=true;if(className=="[object Array]"){size=a.length;result=size==b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break}}}else{var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)){return false}for(var key in a){if(_.has(a,key)){size++;if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break}}if(result){for(key in b){if(_.has(b,key)&&!size--)break}result=!size}}aStack.pop();bStack.pop();return result};_.isEqual=function(a,b){return eq(a,b,[],[])};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)=="[object Array]"};_.isObject=function(obj){return obj===Object(obj)};each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)=="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return!!(obj&&_.has(obj,"callee"))}}if(typeof/./!=="function"){_.isFunction=function(obj){return typeof obj==="function"}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!=+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)=="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.times=function(n,iterator,context){var accum=Array(n);for(var i=0;i<n;i++)accum[i]=iterator.call(context,i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};var entityMap={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};entityMap.unescape=_.invert(entityMap.escape);var entityRegexes={escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g"),unescape:new RegExp("("+_.keys(entityMap.unescape).join("|")+")","g")};_.each(["escape","unescape"],function(method){_[method]=function(string){if(string==null)return"";return(""+string).replace(entityRegexes[method],function(match){return entityMap[method][match]})}});_.result=function(object,property){if(object==null)return null;var value=object[property];return _.isFunction(value)?value.call(object):value};_.mixin=function(obj){each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args))}})};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\t|\u2028|\u2029/g;_.template=function(text,data,settings){var render;settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,function(match){return"\\"+escapes[match]});if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}if(evaluate){source+="';\n"+evaluate+"\n__p+='"}index=offset+match.length;return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}if(data)return render(data,_);var template=function(data){return render.call(this,data,_)};template.source="function("+(settings.variable||"obj")+"){\n"+source+"}";return template};_.chain=function(obj){return _(obj).chain()};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin(_);each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name=="shift"||name=="splice")&&obj.length===0)delete obj[0];return result.call(this,obj)}});each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}});_.extend(_.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this)},{}],22:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canMutationObserver=typeof window!=="undefined"&&window.MutationObserver;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}var queue=[];if(canMutationObserver){var hiddenDiv=document.createElement("div");var observer=new MutationObserver(function(){var queueList=queue.slice();queue.length=0;queueList.forEach(function(fn){fn()})});observer.observe(hiddenDiv,{attributes:true});return function nextTick(fn){if(!queue.length){hiddenDiv.setAttribute("yes","no")}queue.push(fn)}}if(canPost){window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],23:[function(require,module,exports){"use strict";var SDPUtils={};SDPUtils.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};SDPUtils.localCName=SDPUtils.generateIdentifier();SDPUtils.splitLines=function(blob){return blob.trim().split("\n").map(function(line){return line.trim()})};SDPUtils.splitSections=function(blob){var parts=blob.split("\nm=");return parts.map(function(part,index){return(index>0?"m="+part:part).trim()+"\r\n"})};SDPUtils.matchPrefix=function(blob,prefix){return SDPUtils.splitLines(blob).filter(function(line){return line.indexOf(prefix)===0})};SDPUtils.parseCandidate=function(line){var parts;if(line.indexOf("a=candidate:")===0){parts=line.substring(12).split(" ")}else{parts=line.substring(10).split(" ")}var candidate={foundation:parts[0],component:parts[1],protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],port:parseInt(parts[5],10),type:parts[7]};for(var i=8;i<parts.length;i+=2){switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1];break;default:break}}return candidate};SDPUtils.writeCandidate=function(candidate){var sdp=[];sdp.push(candidate.foundation);sdp.push(candidate.component);sdp.push(candidate.protocol.toUpperCase());sdp.push(candidate.priority);sdp.push(candidate.ip);sdp.push(candidate.port);var type=candidate.type;sdp.push("typ");sdp.push(type);if(type!=="host"&&candidate.relatedAddress&&candidate.relatedPort){sdp.push("raddr");sdp.push(candidate.relatedAddress);sdp.push("rport");sdp.push(candidate.relatedPort)}if(candidate.tcpType&&candidate.protocol.toLowerCase()==="tcp"){sdp.push("tcptype");sdp.push(candidate.tcpType)}return"candidate:"+sdp.join(" ")};SDPUtils.parseRtpMap=function(line){var parts=line.substr(9).split(" ");var parsed={payloadType:parseInt(parts.shift(),10)};parts=parts[0].split("/");parsed.name=parts[0];parsed.clockRate=parseInt(parts[1],10);parsed.numChannels=parts.length===3?parseInt(parts[2],10):1;return parsed};SDPUtils.writeRtpMap=function(codec){var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}return"a=rtpmap:"+pt+" "+codec.name+"/"+codec.clockRate+(codec.numChannels!==1?"/"+codec.numChannels:"")+"\r\n"};SDPUtils.parseExtmap=function(line){var parts=line.substr(9).split(" ");return{id:parseInt(parts[0],10),uri:parts[1]}};SDPUtils.writeExtmap=function(headerExtension){return"a=extmap:"+(headerExtension.id||headerExtension.preferredId)+" "+headerExtension.uri+"\r\n"};SDPUtils.parseFmtp=function(line){var parsed={};var kv;var parts=line.substr(line.indexOf(" ")+1).split(";");for(var j=0;j<parts.length;j++){kv=parts[j].trim().split("=");parsed[kv[0].trim()]=kv[1]}return parsed};SDPUtils.writeFmtp=function(codec){var line="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.parameters&&Object.keys(codec.parameters).length){var params=[];Object.keys(codec.parameters).forEach(function(param){params.push(param+"="+codec.parameters[param])});line+="a=fmtp:"+pt+" "+params.join(";")+"\r\n"}return line};SDPUtils.parseRtcpFb=function(line){var parts=line.substr(line.indexOf(" ")+1).split(" ");return{type:parts.shift(),parameter:parts.join(" ")}};SDPUtils.writeRtcpFb=function(codec){var lines="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.rtcpFeedback&&codec.rtcpFeedback.length){codec.rtcpFeedback.forEach(function(fb){lines+="a=rtcp-fb:"+pt+" "+fb.type+(fb.parameter&&fb.parameter.length?" "+fb.parameter:"")+"\r\n"})}return lines};SDPUtils.parseSsrcMedia=function(line){var sp=line.indexOf(" ");var parts={ssrc:parseInt(line.substr(7,sp-7),10)};var colon=line.indexOf(":",sp);if(colon>-1){parts.attribute=line.substr(sp+1,colon-sp-1);parts.value=line.substr(colon+1)}else{parts.attribute=line.substr(sp+1)}return parts};SDPUtils.getDtlsParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);lines=lines.concat(SDPUtils.splitLines(sessionpart));var fpLine=lines.filter(function(line){return line.indexOf("a=fingerprint:")===0})[0].substr(14);var dtlsParameters={role:"auto",fingerprints:[{algorithm:fpLine.split(" ")[0],value:fpLine.split(" ")[1]}]};return dtlsParameters};SDPUtils.writeDtlsParameters=function(params,setupType){var sdp="a=setup:"+setupType+"\r\n";params.fingerprints.forEach(function(fp){sdp+="a=fingerprint:"+fp.algorithm+" "+fp.value+"\r\n"});return sdp};SDPUtils.getIceParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);lines=lines.concat(SDPUtils.splitLines(sessionpart));var iceParameters={usernameFragment:lines.filter(function(line){return line.indexOf("a=ice-ufrag:")===0})[0].substr(12),password:lines.filter(function(line){return line.indexOf("a=ice-pwd:")===0})[0].substr(10)};return iceParameters};SDPUtils.writeIceParameters=function(params){return"a=ice-ufrag:"+params.usernameFragment+"\r\n"+"a=ice-pwd:"+params.password+"\r\n"};SDPUtils.parseRtpParameters=function(mediaSection){var description={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].split(" ");for(var i=3;i<mline.length;i++){var pt=mline[i];var rtpmapline=SDPUtils.matchPrefix(mediaSection,"a=rtpmap:"+pt+" ")[0];if(rtpmapline){var codec=SDPUtils.parseRtpMap(rtpmapline);var fmtps=SDPUtils.matchPrefix(mediaSection,"a=fmtp:"+pt+" ");codec.parameters=fmtps.length?SDPUtils.parseFmtp(fmtps[0]):{};codec.rtcpFeedback=SDPUtils.matchPrefix(mediaSection,"a=rtcp-fb:"+pt+" ").map(SDPUtils.parseRtcpFb);description.codecs.push(codec);switch(codec.name.toUpperCase()){case"RED":case"ULPFEC":description.fecMechanisms.push(codec.name.toUpperCase());break;default:break}}}SDPUtils.matchPrefix(mediaSection,"a=extmap:").forEach(function(line){description.headerExtensions.push(SDPUtils.parseExtmap(line))});return description};SDPUtils.writeRtpDescription=function(kind,caps){var sdp="";sdp+="m="+kind+" ";sdp+=caps.codecs.length>0?"9":"0";sdp+=" UDP/TLS/RTP/SAVPF ";sdp+=caps.codecs.map(function(codec){if(codec.preferredPayloadType!==undefined){return codec.preferredPayloadType}return codec.payloadType}).join(" ")+"\r\n";sdp+="c=IN IP4 0.0.0.0\r\n";sdp+="a=rtcp:9 IN IP4 0.0.0.0\r\n";caps.codecs.forEach(function(codec){sdp+=SDPUtils.writeRtpMap(codec);sdp+=SDPUtils.writeFmtp(codec);sdp+=SDPUtils.writeRtcpFb(codec)});sdp+="a=rtcp-mux\r\n";return sdp};SDPUtils.parseRtpEncodingParameters=function(mediaSection){var encodingParameters=[];var description=SDPUtils.parseRtpParameters(mediaSection);var hasRed=description.fecMechanisms.indexOf("RED")!==-1;var hasUlpfec=description.fecMechanisms.indexOf("ULPFEC")!==-1;var ssrcs=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(parts){return parts.attribute==="cname"});var primarySsrc=ssrcs.length>0&&ssrcs[0].ssrc;var secondarySsrc;var flows=SDPUtils.matchPrefix(mediaSection,"a=ssrc-group:FID").map(function(line){var parts=line.split(" ");parts.shift();return parts.map(function(part){return parseInt(part,10)})});if(flows.length>0&&flows[0].length>1&&flows[0][0]===primarySsrc){secondarySsrc=flows[0][1]}description.codecs.forEach(function(codec){if(codec.name.toUpperCase()==="RTX"&&codec.parameters.apt){var encParam={ssrc:primarySsrc,codecPayloadType:parseInt(codec.parameters.apt,10),rtx:{payloadType:codec.payloadType,ssrc:secondarySsrc}};encodingParameters.push(encParam);if(hasRed){encParam=JSON.parse(JSON.stringify(encParam));encParam.fec={ssrc:secondarySsrc,mechanism:hasUlpfec?"red+ulpfec":"red"};encodingParameters.push(encParam)}}});if(encodingParameters.length===0&&primarySsrc){encodingParameters.push({ssrc:primarySsrc})}var bandwidth=SDPUtils.matchPrefix(mediaSection,"b=");if(bandwidth.length){if(bandwidth[0].indexOf("b=TIAS:")===0){bandwidth=parseInt(bandwidth[0].substr(7),10)}else if(bandwidth[0].indexOf("b=AS:")===0){bandwidth=parseInt(bandwidth[0].substr(5),10)}encodingParameters.forEach(function(params){params.maxBitrate=bandwidth})}return encodingParameters};SDPUtils.writeSessionBoilerplate=function(){return"v=0\r\n"+"o=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\n"+"s=-\r\n"+"t=0 0\r\n"};SDPUtils.writeMediaSection=function(transceiver,caps,type,stream){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters());sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),type==="offer"?"actpass":"active");sdp+="a=mid:"+transceiver.mid+"\r\n";if(transceiver.rtpSender&&transceiver.rtpReceiver){sdp+="a=sendrecv\r\n"}else if(transceiver.rtpSender){sdp+="a=sendonly\r\n"}else if(transceiver.rtpReceiver){sdp+="a=recvonly\r\n"}else{sdp+="a=inactive\r\n"}if(transceiver.rtpSender){var msid="msid:"+stream.id+" "+transceiver.rtpSender.track.id+"\r\n";sdp+="a="+msid;sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid}sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n";return sdp};SDPUtils.getDirection=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);for(var i=0;i<lines.length;i++){switch(lines[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return lines[i].substr(2);default:}}if(sessionpart){return SDPUtils.getDirection(sessionpart)}return"sendrecv"};module.exports=SDPUtils},{}],24:[function(require,module,exports){(function(){var root=this;var previousUnderscore=root._;var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind,nativeCreate=Object.create;var Ctor=function(){};var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.8.3";var optimizeCb=function(func,context,argCount){if(context===void 0)return func;switch(argCount==null?3:argCount){case 1:return function(value){return func.call(context,value)};case 2:return function(value,other){return func.call(context,value,other)};case 3:return function(value,index,collection){return func.call(context,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(context,accumulator,value,index,collection)}}return function(){return func.apply(context,arguments)}};var cb=function(value,context,argCount){if(value==null)return _.identity;if(_.isFunction(value))return optimizeCb(value,context,argCount);if(_.isObject(value))return _.matcher(value);return _.property(value)};_.iteratee=function(value,context){return cb(value,context,Infinity)};var createAssigner=function(keysFunc,undefinedOnly){return function(obj){var length=arguments.length;if(length<2||obj==null)return obj;for(var index=1;index<length;index++){var source=arguments[index],keys=keysFunc(source),l=keys.length;for(var i=0;i<l;i++){var key=keys[i];if(!undefinedOnly||obj[key]===void 0)obj[key]=source[key]}}return obj}};var baseCreate=function(prototype){if(!_.isObject(prototype))return{};if(nativeCreate)return nativeCreate(prototype);Ctor.prototype=prototype;var result=new Ctor;Ctor.prototype=null;return result};var property=function(key){return function(obj){return obj==null?void 0:obj[key]}};var MAX_ARRAY_INDEX=Math.pow(2,53)-1;var getLength=property("length");var isArrayLike=function(collection){var length=getLength(collection);return typeof length=="number"&&length>=0&&length<=MAX_ARRAY_INDEX};_.each=_.forEach=function(obj,iteratee,context){iteratee=optimizeCb(iteratee,context);var i,length;if(isArrayLike(obj)){for(i=0,length=obj.length;i<length;i++){iteratee(obj[i],i,obj)}}else{var keys=_.keys(obj);for(i=0,length=keys.length;i<length;i++){iteratee(obj[keys[i]],keys[i],obj)}}return obj};_.map=_.collect=function(obj,iteratee,context){iteratee=cb(iteratee,context);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,results=Array(length);for(var index=0;index<length;index++){var currentKey=keys?keys[index]:index;results[index]=iteratee(obj[currentKey],currentKey,obj)}return results};function createReduce(dir){function iterator(obj,iteratee,memo,keys,index,length){for(;index>=0&&index<length;index+=dir){var currentKey=keys?keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo}return function(obj,iteratee,memo,context){iteratee=optimizeCb(iteratee,context,4);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,index=dir>0?0:length-1;if(arguments.length<3){memo=obj[keys?keys[index]:index];index+=dir}return iterator(obj,iteratee,memo,keys,index,length)}}_.reduce=_.foldl=_.inject=createReduce(1);_.reduceRight=_.foldr=createReduce(-1);_.find=_.detect=function(obj,predicate,context){var key;if(isArrayLike(obj)){key=_.findIndex(obj,predicate,context)}else{key=_.findKey(obj,predicate,context)}if(key!==void 0&&key!==-1)return obj[key]};_.filter=_.select=function(obj,predicate,context){var results=[];predicate=cb(predicate,context);_.each(obj,function(value,index,list){if(predicate(value,index,list))results.push(value)});return results};_.reject=function(obj,predicate,context){return _.filter(obj,_.negate(cb(predicate)),context)};_.every=_.all=function(obj,predicate,context){predicate=cb(predicate,context);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length;for(var index=0;index<length;index++){var currentKey=keys?keys[index]:index;if(!predicate(obj[currentKey],currentKey,obj))return false}return true};_.some=_.any=function(obj,predicate,context){predicate=cb(predicate,context);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length;for(var index=0;index<length;index++){var currentKey=keys?keys[index]:index;if(predicate(obj[currentKey],currentKey,obj))return true}return false};_.contains=_.includes=_.include=function(obj,item,fromIndex,guard){if(!isArrayLike(obj))obj=_.values(obj);if(typeof fromIndex!="number"||guard)fromIndex=0;return _.indexOf(obj,item,fromIndex)>=0};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){var func=isFunc?method:value[method];return func==null?func:func.apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,_.property(key))};_.where=function(obj,attrs){return _.filter(obj,_.matcher(attrs))};_.findWhere=function(obj,attrs){return _.find(obj,_.matcher(attrs))};_.max=function(obj,iteratee,context){var result=-Infinity,lastComputed=-Infinity,value,computed;if(iteratee==null&&obj!=null){obj=isArrayLike(obj)?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value>result){result=value}}}else{iteratee=cb(iteratee,context);_.each(obj,function(value,index,list){computed=iteratee(value,index,list);if(computed>lastComputed||computed===-Infinity&&result===-Infinity){result=value;lastComputed=computed}})}return result};_.min=function(obj,iteratee,context){var result=Infinity,lastComputed=Infinity,value,computed;if(iteratee==null&&obj!=null){obj=isArrayLike(obj)?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value<result){result=value}}}else{iteratee=cb(iteratee,context);_.each(obj,function(value,index,list){computed=iteratee(value,index,list);if(computed<lastComputed||computed===Infinity&&result===Infinity){result=value;lastComputed=computed}})}return result};_.shuffle=function(obj){var set=isArrayLike(obj)?obj:_.values(obj);var length=set.length;var shuffled=Array(length);for(var index=0,rand;index<length;index++){rand=_.random(0,index);if(rand!==index)shuffled[index]=shuffled[rand];shuffled[rand]=set[index]}return shuffled};_.sample=function(obj,n,guard){if(n==null||guard){if(!isArrayLike(obj))obj=_.values(obj);return obj[_.random(obj.length-1)]}return _.shuffle(obj).slice(0,Math.max(0,n))};_.sortBy=function(obj,iteratee,context){iteratee=cb(iteratee,context);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iteratee(value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,iteratee,context){var result={};iteratee=cb(iteratee,context);_.each(obj,function(value,index){var key=iteratee(value,index,obj);behavior(result,value,key)});return result}};_.groupBy=group(function(result,value,key){if(_.has(result,key))result[key].push(value);else result[key]=[value]});_.indexBy=group(function(result,value,key){result[key]=value});_.countBy=group(function(result,value,key){if(_.has(result,key))result[key]++;else result[key]=1});_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(isArrayLike(obj))return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return isArrayLike(obj)?obj.length:_.keys(obj).length};_.partition=function(obj,predicate,context){predicate=cb(predicate,context);var pass=[],fail=[];_.each(obj,function(value,key,obj){(predicate(value,key,obj)?pass:fail).push(value)});return[pass,fail]};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[0];return _.initial(array,array.length-n)};_.initial=function(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(n==null||guard?1:n)))};_.last=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[array.length-1];return _.rest(array,Math.max(0,array.length-n))};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,strict,startIndex){var output=[],idx=0;for(var i=startIndex||0,length=getLength(input);i<length;i++){var value=input[i];if(isArrayLike(value)&&(_.isArray(value)||_.isArguments(value))){if(!shallow)value=flatten(value,shallow,strict);var j=0,len=value.length;output.length+=len;while(j<len){output[idx++]=value[j++]}}else if(!strict){output[idx++]=value}}return output};_.flatten=function(array,shallow){return flatten(array,shallow,false)};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted,iteratee,context){if(!_.isBoolean(isSorted)){context=iteratee;iteratee=isSorted;isSorted=false}if(iteratee!=null)iteratee=cb(iteratee,context);var result=[];var seen=[];for(var i=0,length=getLength(array);i<length;i++){var value=array[i],computed=iteratee?iteratee(value,i,array):value;if(isSorted){if(!i||seen!==computed)result.push(value);seen=computed}else if(iteratee){if(!_.contains(seen,computed)){seen.push(computed);result.push(value)}}else if(!_.contains(result,value)){result.push(value)}}return result};_.union=function(){return _.uniq(flatten(arguments,true,true))};_.intersection=function(array){var result=[];var argsLength=arguments.length;for(var i=0,length=getLength(array);i<length;i++){var item=array[i];if(_.contains(result,item))continue;for(var j=1;j<argsLength;j++){if(!_.contains(arguments[j],item))break}if(j===argsLength)result.push(item)}return result};_.difference=function(array){var rest=flatten(arguments,true,true,1);return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(){return _.unzip(arguments)};_.unzip=function(array){var length=array&&_.max(array,getLength).length||0;var result=Array(length);for(var index=0;index<length;index++){result[index]=_.pluck(array,index)}return result};_.object=function(list,values){
var result={};for(var i=0,length=getLength(list);i<length;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};function createPredicateIndexFinder(dir){return function(array,predicate,context){predicate=cb(predicate,context);var length=getLength(array);var index=dir>0?0:length-1;for(;index>=0&&index<length;index+=dir){if(predicate(array[index],index,array))return index}return-1}}_.findIndex=createPredicateIndexFinder(1);_.findLastIndex=createPredicateIndexFinder(-1);_.sortedIndex=function(array,obj,iteratee,context){iteratee=cb(iteratee,context,1);var value=iteratee(obj);var low=0,high=getLength(array);while(low<high){var mid=Math.floor((low+high)/2);if(iteratee(array[mid])<value)low=mid+1;else high=mid}return low};function createIndexFinder(dir,predicateFind,sortedIndex){return function(array,item,idx){var i=0,length=getLength(array);if(typeof idx=="number"){if(dir>0){i=idx>=0?idx:Math.max(idx+length,i)}else{length=idx>=0?Math.min(idx+1,length):idx+length+1}}else if(sortedIndex&&idx&&length){idx=sortedIndex(array,item);return array[idx]===item?idx:-1}if(item!==item){idx=predicateFind(slice.call(array,i,length),_.isNaN);return idx>=0?idx+i:-1}for(idx=dir>0?i:length-1;idx>=0&&idx<length;idx+=dir){if(array[idx]===item)return idx}return-1}}_.indexOf=createIndexFinder(1,_.findIndex,_.sortedIndex);_.lastIndexOf=createIndexFinder(-1,_.findLastIndex);_.range=function(start,stop,step){if(stop==null){stop=start||0;start=0}step=step||1;var length=Math.max(Math.ceil((stop-start)/step),0);var range=Array(length);for(var idx=0;idx<length;idx++,start+=step){range[idx]=start}return range};var executeBound=function(sourceFunc,boundFunc,context,callingContext,args){if(!(callingContext instanceof boundFunc))return sourceFunc.apply(context,args);var self=baseCreate(sourceFunc.prototype);var result=sourceFunc.apply(self,args);if(_.isObject(result))return result;return self};_.bind=function(func,context){if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError("Bind must be called on a function");var args=slice.call(arguments,2);var bound=function(){return executeBound(func,bound,context,this,args.concat(slice.call(arguments)))};return bound};_.partial=function(func){var boundArgs=slice.call(arguments,1);var bound=function(){var position=0,length=boundArgs.length;var args=Array(length);for(var i=0;i<length;i++){args[i]=boundArgs[i]===_?arguments[position++]:boundArgs[i]}while(position<arguments.length)args.push(arguments[position++]);return executeBound(func,bound,this,this,args)};return bound};_.bindAll=function(obj){var i,length=arguments.length,key;if(length<=1)throw new Error("bindAll must be passed function names");for(i=1;i<length;i++){key=arguments[i];obj[key]=_.bind(obj[key],obj)}return obj};_.memoize=function(func,hasher){var memoize=function(key){var cache=memoize.cache;var address=""+(hasher?hasher.apply(this,arguments):key);if(!_.has(cache,address))cache[address]=func.apply(this,arguments);return cache[address]};memoize.cache={};return memoize};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=_.partial(_.delay,_,1);_.throttle=function(func,wait,options){var context,args,result;var timeout=null;var previous=0;if(!options)options={};var later=function(){previous=options.leading===false?0:_.now();timeout=null;result=func.apply(context,args);if(!timeout)context=args=null};return function(){var now=_.now();if(!previous&&options.leading===false)previous=now;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0||remaining>wait){if(timeout){clearTimeout(timeout);timeout=null}previous=now;result=func.apply(context,args);if(!timeout)context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result;var later=function(){var last=_.now()-timestamp;if(last<wait&&last>=0){timeout=setTimeout(later,wait-last)}else{timeout=null;if(!immediate){result=func.apply(context,args);if(!timeout)context=args=null}}};return function(){context=this;args=arguments;timestamp=_.now();var callNow=immediate&&!timeout;if(!timeout)timeout=setTimeout(later,wait);if(callNow){result=func.apply(context,args);context=args=null}return result}};_.wrap=function(func,wrapper){return _.partial(wrapper,func)};_.negate=function(predicate){return function(){return!predicate.apply(this,arguments)}};_.compose=function(){var args=arguments;var start=args.length-1;return function(){var i=start;var result=args[start].apply(this,arguments);while(i--)result=args[i].call(this,result);return result}};_.after=function(times,func){return function(){if(--times<1){return func.apply(this,arguments)}}};_.before=function(times,func){var memo;return function(){if(--times>0){memo=func.apply(this,arguments)}if(times<=1)func=null;return memo}};_.once=_.partial(_.before,2);var hasEnumBug=!{toString:null}.propertyIsEnumerable("toString");var nonEnumerableProps=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];function collectNonEnumProps(obj,keys){var nonEnumIdx=nonEnumerableProps.length;var constructor=obj.constructor;var proto=_.isFunction(constructor)&&constructor.prototype||ObjProto;var prop="constructor";if(_.has(obj,prop)&&!_.contains(keys,prop))keys.push(prop);while(nonEnumIdx--){prop=nonEnumerableProps[nonEnumIdx];if(prop in obj&&obj[prop]!==proto[prop]&&!_.contains(keys,prop)){keys.push(prop)}}}_.keys=function(obj){if(!_.isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)if(_.has(obj,key))keys.push(key);if(hasEnumBug)collectNonEnumProps(obj,keys);return keys};_.allKeys=function(obj){if(!_.isObject(obj))return[];var keys=[];for(var key in obj)keys.push(key);if(hasEnumBug)collectNonEnumProps(obj,keys);return keys};_.values=function(obj){var keys=_.keys(obj);var length=keys.length;var values=Array(length);for(var i=0;i<length;i++){values[i]=obj[keys[i]]}return values};_.mapObject=function(obj,iteratee,context){iteratee=cb(iteratee,context);var keys=_.keys(obj),length=keys.length,results={},currentKey;for(var index=0;index<length;index++){currentKey=keys[index];results[currentKey]=iteratee(obj[currentKey],currentKey,obj)}return results};_.pairs=function(obj){var keys=_.keys(obj);var length=keys.length;var pairs=Array(length);for(var i=0;i<length;i++){pairs[i]=[keys[i],obj[keys[i]]]}return pairs};_.invert=function(obj){var result={};var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i]}return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=createAssigner(_.allKeys);_.extendOwn=_.assign=createAssigner(_.keys);_.findKey=function(obj,predicate,context){predicate=cb(predicate,context);var keys=_.keys(obj),key;for(var i=0,length=keys.length;i<length;i++){key=keys[i];if(predicate(obj[key],key,obj))return key}};_.pick=function(object,oiteratee,context){var result={},obj=object,iteratee,keys;if(obj==null)return result;if(_.isFunction(oiteratee)){keys=_.allKeys(obj);iteratee=optimizeCb(oiteratee,context)}else{keys=flatten(arguments,false,false,1);iteratee=function(value,key,obj){return key in obj};obj=Object(obj)}for(var i=0,length=keys.length;i<length;i++){var key=keys[i];var value=obj[key];if(iteratee(value,key,obj))result[key]=value}return result};_.omit=function(obj,iteratee,context){if(_.isFunction(iteratee)){iteratee=_.negate(iteratee)}else{var keys=_.map(flatten(arguments,false,false,1),String);iteratee=function(value,key){return!_.contains(keys,key)}}return _.pick(obj,iteratee,context)};_.defaults=createAssigner(_.allKeys,true);_.create=function(prototype,props){var result=baseCreate(prototype);if(props)_.extendOwn(result,props);return result};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};_.isMatch=function(object,attrs){var keys=_.keys(attrs),length=keys.length;if(object==null)return!length;var obj=Object(object);for(var i=0;i<length;i++){var key=keys[i];if(attrs[key]!==obj[key]||!(key in obj))return false}return true};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a===1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!==toString.call(b))return false;switch(className){case"[object RegExp]":case"[object String]":return""+a===""+b;case"[object Number]":if(+a!==+a)return+b!==+b;return+a===0?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b}var areArrays=className==="[object Array]";if(!areArrays){if(typeof a!="object"||typeof b!="object")return false;var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)&&("constructor"in a&&"constructor"in b)){return false}}aStack=aStack||[];bStack=bStack||[];var length=aStack.length;while(length--){if(aStack[length]===a)return bStack[length]===b}aStack.push(a);bStack.push(b);if(areArrays){length=a.length;if(length!==b.length)return false;while(length--){if(!eq(a[length],b[length],aStack,bStack))return false}}else{var keys=_.keys(a),key;length=keys.length;if(_.keys(b).length!==length)return false;while(length--){key=keys[length];if(!(_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))return false}}aStack.pop();bStack.pop();return true};_.isEqual=function(a,b){return eq(a,b)};_.isEmpty=function(obj){if(obj==null)return true;if(isArrayLike(obj)&&(_.isArray(obj)||_.isString(obj)||_.isArguments(obj)))return obj.length===0;return _.keys(obj).length===0};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)==="[object Array]"};_.isObject=function(obj){var type=typeof obj;return type==="function"||type==="object"&&!!obj};_.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(name){_["is"+name]=function(obj){return toString.call(obj)==="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return _.has(obj,"callee")}}if(typeof/./!="function"&&typeof Int8Array!="object"){_.isFunction=function(obj){return typeof obj=="function"||false}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!==+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)==="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return obj!=null&&hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.constant=function(value){return function(){return value}};_.noop=function(){};_.property=property;_.propertyOf=function(obj){return obj==null?function(){}:function(key){return obj[key]}};_.matcher=_.matches=function(attrs){attrs=_.extendOwn({},attrs);return function(obj){return _.isMatch(obj,attrs)}};_.times=function(n,iteratee,context){var accum=Array(Math.max(0,n));iteratee=optimizeCb(iteratee,context,1);for(var i=0;i<n;i++)accum[i]=iteratee(i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};_.now=Date.now||function(){return(new Date).getTime()};var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};var unescapeMap=_.invert(escapeMap);var createEscaper=function(map){var escaper=function(match){return map[match]};var source="(?:"+_.keys(map).join("|")+")";var testRegexp=RegExp(source);var replaceRegexp=RegExp(source,"g");return function(string){string=string==null?"":""+string;return testRegexp.test(string)?string.replace(replaceRegexp,escaper):string}};_.escape=createEscaper(escapeMap);_.unescape=createEscaper(unescapeMap);_.result=function(object,property,fallback){var value=object==null?void 0:object[property];if(value===void 0){value=fallback}return _.isFunction(value)?value.call(object):value};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\u2028|\u2029/g;var escapeChar=function(match){return"\\"+escapes[match]};_.template=function(text,settings,oldSettings){if(!settings&&oldSettings)settings=oldSettings;settings=_.defaults({},settings,_.templateSettings);var matcher=RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,escapeChar);index=offset+match.length;if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}else if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}else if(evaluate){source+="';\n"+evaluate+"\n__p+='"}return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{var render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}var template=function(data){return render.call(this,data,_)};var argument=settings.variable||"obj";template.source="function("+argument+"){\n"+source+"}";return template};_.chain=function(obj){var instance=_(obj);instance._chain=true;return instance};var result=function(instance,obj){return instance._chain?_(obj).chain():obj};_.mixin=function(obj){_.each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result(this,func.apply(_,args))}})};_.mixin(_);_.each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name==="shift"||name==="splice")&&obj.length===0)delete obj[0];return result(this,obj)}});_.each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result(this,method.apply(this._wrapped,arguments))}});_.prototype.value=function(){return this._wrapped};_.prototype.valueOf=_.prototype.toJSON=_.prototype.value;_.prototype.toString=function(){return""+this._wrapped};if(typeof define==="function"&&define.amd){define("underscore",[],function(){return _})}}).call(this)},{}],25:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],26:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.readUInt8==="function"}},{}],27:[function(require,module,exports){(function(process,global){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg!==null}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;exports.isBuffer=require("./support/isBuffer");function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=require("inherits");exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./support/isBuffer":26,_process:22,inherits:25}],28:[function(require,module,exports){var WAAClock=require("./lib/WAAClock");module.exports=WAAClock;if(typeof window!=="undefined")window.WAAClock=WAAClock},{"./lib/WAAClock":29}],29:[function(require,module,exports){(function(process){var isBrowser=typeof window!=="undefined";var CLOCK_DEFAULTS={toleranceLate:.1,toleranceEarly:.001};var Event=function(clock,deadline,func){this.clock=clock;this.func=func;this._cleared=false;this.toleranceLate=clock.toleranceLate;this.toleranceEarly=clock.toleranceEarly;this._latestTime=null;this._earliestTime=null;this.deadline=null;this.repeatTime=null;this.schedule(deadline)};Event.prototype.clear=function(){this.clock._removeEvent(this);this._cleared=true;return this};Event.prototype.repeat=function(time){if(time===0)throw new Error("delay cannot be 0");this.repeatTime=time;if(!this.clock._hasEvent(this))this.schedule(this.deadline+this.repeatTime);return this};Event.prototype.tolerance=function(values){if(typeof values.late==="number")this.toleranceLate=values.late;if(typeof values.early==="number")this.toleranceEarly=values.early;this._refreshEarlyLateDates();if(this.clock._hasEvent(this)){this.clock._removeEvent(this);this.clock._insertEvent(this)}return this};Event.prototype.isRepeated=function(){return this.repeatTime!==null};Event.prototype.schedule=function(deadline){this._cleared=false;this.deadline=deadline;this._refreshEarlyLateDates();if(this.clock.context.currentTime>=this._earliestTime){this._execute()}else if(this.clock._hasEvent(this)){this.clock._removeEvent(this);this.clock._insertEvent(this)}else this.clock._insertEvent(this)};Event.prototype.timeStretch=function(tRef,ratio){if(this.isRepeated())this.repeatTime=this.repeatTime*ratio;var deadline=tRef+ratio*(this.deadline-tRef);if(this.isRepeated()){while(this.clock.context.currentTime>=deadline-this.toleranceEarly)deadline+=this.repeatTime}this.schedule(deadline)};Event.prototype._execute=function(){if(this.clock._started===false)return;this.clock._removeEvent(this);if(this.clock.context.currentTime<this._latestTime)this.func(this);else{if(this.onexpired)this.onexpired(this);console.warn("event expired")}if(!this.clock._hasEvent(this)&&this.isRepeated()&&!this._cleared)this.schedule(this.deadline+this.repeatTime)};Event.prototype._refreshEarlyLateDates=function(){this._latestTime=this.deadline+this.toleranceLate;this._earliestTime=this.deadline-this.toleranceEarly};var WAAClock=module.exports=function(context,opts){var self=this;opts=opts||{};this.tickMethod=opts.tickMethod||"ScriptProcessorNode";this.toleranceEarly=opts.toleranceEarly||CLOCK_DEFAULTS.toleranceEarly;this.toleranceLate=opts.toleranceLate||CLOCK_DEFAULTS.toleranceLate;this.context=context;this._events=[];this._started=false};WAAClock.prototype.setTimeout=function(func,delay){return this._createEvent(func,this._absTime(delay))};WAAClock.prototype.callbackAtTime=function(func,deadline){return this._createEvent(func,deadline)};WAAClock.prototype.timeStretch=function(tRef,events,ratio){events.forEach(function(event){event.timeStretch(tRef,ratio)});return events};WAAClock.prototype.start=function(){if(this._started===false){var self=this;this._started=true;this._events=[];if(this.tickMethod==="ScriptProcessorNode"){var bufferSize=256;this._clockNode=this.context.createScriptProcessor(bufferSize,1,1);this._clockNode.connect(this.context.destination);this._clockNode.onaudioprocess=function(){process.nextTick(function(){self._tick()})}}else if(this.tickMethod==="manual")null;else throw new Error("invalid tickMethod "+this.tickMethod)}};WAAClock.prototype.stop=function(){if(this._started===true){this._started=false;this._clockNode.disconnect()}};WAAClock.prototype._tick=function(){var event=this._events.shift();while(event&&event._earliestTime<=this.context.currentTime){event._execute();event=this._events.shift()}if(event)this._events.unshift(event)};WAAClock.prototype._createEvent=function(func,deadline){return new Event(this,deadline,func)};WAAClock.prototype._insertEvent=function(event){this._events.splice(this._indexByTime(event._earliestTime),0,event)};WAAClock.prototype._removeEvent=function(event){var ind=this._events.indexOf(event);if(ind!==-1)this._events.splice(ind,1)};WAAClock.prototype._hasEvent=function(event){return this._events.indexOf(event)!==-1};WAAClock.prototype._indexByTime=function(deadline){var low=0,high=this._events.length,mid;while(low<high){mid=Math.floor((low+high)/2);if(this._events[mid]._earliestTime<deadline)low=mid+1;else high=mid}return low};WAAClock.prototype._absTime=function(relTime){return relTime+this.context.currentTime};WAAClock.prototype._relTime=function(absTime){return absTime-this.context.currentTime}}).call(this,require("_process"))},{_process:22}],30:[function(require,module,exports){var WAAOffsetNode=require("./lib/WAAOffsetNode");module.exports=WAAOffsetNode;if(typeof window!=="undefined")window.WAAOffsetNode=WAAOffsetNode},{"./lib/WAAOffsetNode":31}],31:[function(require,module,exports){var WAAOffsetNode=module.exports=function(context){this.context=context;this._ones=WAAOffsetNode._ones.filter(function(ones){return ones.context===context})[0];if(this._ones)this._ones=this._ones.ones;else{var buffer=context.createBuffer(1,1024,context.sampleRate),i,channelArray=buffer.getChannelData(0);for(i=0;i<buffer.length;i++)channelArray[i]=1;this._ones=context.createBufferSource();this._ones.buffer=buffer;this._ones.loop=true;this._ones.start(0);WAAOffsetNode._ones.push({context:context,ones:this._ones})}this._output=context.createGain();this._ones.connect(this._output);this.offset=this._output.gain;this.offset.value=0};WAAOffsetNode.prototype.connect=function(){this._output.connect.apply(this._output,arguments)};WAAOffsetNode.prototype.disconnect=function(){this._output.disconnect.apply(this._output,arguments)};WAAOffsetNode._ones=[]},{}],32:[function(require,module,exports){var WAATableNode=require("./lib/WAATableNode");module.exports=WAATableNode;if(typeof window!=="undefined")window.WAATableNode=WAATableNode},{"./lib/WAATableNode":33}],33:[function(require,module,exports){var WAAOffset=require("waaoffsetnode");var WAATableNode=module.exports=function(context){this.context=context;this._output=context.createWaveShaper();this._positionNode=new WAAOffset(context);this._positionNode.connect(this._output);this._positionNode.offset.value=-1;this.position=context.createGain();this.position.connect(this._positionNode.offset);this.position.gain.value=0;this._table=null;Object.defineProperty(this,"table",{get:function(){return this._table},set:function(table){this._setTable(table)}})};WAATableNode.prototype.connect=function(){this._output.connect.apply(this._output,arguments)};WAATableNode.prototype.disconnect=function(){this._output.disconnect.apply(this._output,arguments)};WAATableNode.prototype._setTable=function(table){if(table instanceof AudioBuffer)table=table.getChannelData(0);this._table=table;if(table===null)return;this._output.curve=table;this.position.gain.setValueAtTime(2/(table.length-1),0)}},{waaoffsetnode:30}],34:[function(require,module,exports){
var WAAWhiteNoiseNode=require("./lib/WAAWhiteNoiseNode");module.exports=WAAWhiteNoiseNode;if(typeof window!=="undefined")window.WAAWhiteNoiseNode=WAAWhiteNoiseNode},{"./lib/WAAWhiteNoiseNode":35}],35:[function(require,module,exports){var WAAWhiteNoiseNode=module.exports=function(context){this.context=context;this._buffer=context.createBuffer(1,131072,context.sampleRate);var channelArray=this._buffer.getChannelData(0),i;for(i=0;i<131072;i++)channelArray[i]=Math.random()*2-1;this._prepareOutput()};WAAWhiteNoiseNode.prototype.connect=function(){this._output.connect.apply(this._output,arguments)};WAAWhiteNoiseNode.prototype.disconnect=function(){this._output.disconnect.apply(this._output,arguments)};WAAWhiteNoiseNode.prototype.start=function(){this._output.start.apply(this._output,arguments)};WAAWhiteNoiseNode.prototype.stop=function(){this._output.stop.apply(this._output,arguments);this._prepareOutput()};WAAWhiteNoiseNode.prototype._prepareOutput=function(){this._output=this.context.createBufferSource();this._output.buffer=this._buffer;this._output.loop=true}},{}],36:[function(require,module,exports){var WAAWire=require("./lib/WAAWire");module.exports=WAAWire;if(typeof window!=="undefined")window.WAAWire=WAAWire},{"./lib/WAAWire":37}],37:[function(require,module,exports){var WAAWire=module.exports=function(context){this.context=context;this._source=null;this._output=null;this._destination=null;this._input=null;this._gainNode=null;this._discardedGainNode=null;this._atTime=0;this._closed=false};var _withTimeArg=function(methName){return function(){this._clean();this[methName].apply(this,[this._atTime].concat([].slice.call(arguments,0)));this._atTime=0;return this}};WAAWire.prototype.connect=_withTimeArg("_connect");WAAWire.prototype.swapSource=_withTimeArg("_swapSource");WAAWire.prototype.swapDestination=_withTimeArg("_swapDestination");WAAWire.prototype.close=_withTimeArg("_close");WAAWire.prototype.atTime=function(time){this._atTime=time;return this};WAAWire.prototype._connect=function(time,source,destination,output,input){if(this._gainNode)throw new Error("Wire already connected");this._source=source;this._destination=destination;this._output=output||0;this._input=input||0;this._doConnections(time)};WAAWire.prototype._swapSource=function(time,source,output){this._discardedGainNode=this._gainNode;this._discardedGainNode.gain.setValueAtTime(0,time);this._source=source;this._output=output||0;this._doConnections(time)};WAAWire.prototype._swapDestination=function(time,destination,input){this._discardedGainNode=this._gainNode;this._discardedGainNode.gain.setValueAtTime(0,time);this._destination=destination;this._input=input||0;this._doConnections(time)};WAAWire.prototype._close=function(time){if(this._closed===true)throw new Error("Wire already closed");this._discardedGainNode=this._gainNode;this._gainNode.gain.setValueAtTime(0,time);this._gainNode=null;this._closed=true};WAAWire.prototype._doConnections=function(time){var gainNode=this.context.createGain();gainNode.gain.setValueAtTime(0,0);gainNode.gain.setValueAtTime(1,time);this._gainNode=gainNode;this._source.connect(gainNode,this._output);if(this._destination instanceof AudioParam)gainNode.connect(this._destination,0);else gainNode.connect(this._destination,0,this._input)};WAAWire.prototype._clean=function(){if(this._discardedGainNode&&this._discardedGainNode.gain.value===0){this._discardedGainNode.disconnect();this._discardedGainNode=null}};var _hasSelectiveDisconnect=function(){if(typeof window!=="undefined"&&window.OfflineAudioContext){var context=new OfflineAudioContext(1,1,44100),bufferNode=context.createBufferSource(),gain=context.createGain(),buffer=context.createBuffer(1,1,44100);buffer.getChannelData(0)[0]=1;bufferNode.buffer=buffer;bufferNode.connect(gain);bufferNode.connect(context.destination);bufferNode.start(0);gain.connect(context.destination);bufferNode.disconnect(gain);context.oncomplete=function(event){_hasSelectiveDisconnectResult=!!event.renderedBuffer.getChannelData(0)[0]};context.startRendering()}},_hasSelectiveDisconnectResult=null;_hasSelectiveDisconnect()},{}],38:[function(require,module,exports){"use strict";(function(){var logging=require("./utils").log;var browserDetails=require("./utils").browserDetails;module.exports.browserDetails=browserDetails;module.exports.extractVersion=require("./utils").extractVersion;module.exports.disableLog=require("./utils").disableLog;var chromeShim=require("./chrome/chrome_shim")||null;var edgeShim=require("./edge/edge_shim")||null;var firefoxShim=require("./firefox/firefox_shim")||null;var safariShim=require("./safari/safari_shim")||null;switch(browserDetails.browser){case"opera":case"chrome":if(!chromeShim||!chromeShim.shimPeerConnection){logging("Chrome shim is not included in this adapter release.");return}logging("adapter.js shimming chrome.");module.exports.browserShim=chromeShim;chromeShim.shimGetUserMedia();chromeShim.shimMediaStream();chromeShim.shimSourceObject();chromeShim.shimPeerConnection();chromeShim.shimOnTrack();break;case"firefox":if(!firefoxShim||!firefoxShim.shimPeerConnection){logging("Firefox shim is not included in this adapter release.");return}logging("adapter.js shimming firefox.");module.exports.browserShim=firefoxShim;firefoxShim.shimGetUserMedia();firefoxShim.shimSourceObject();firefoxShim.shimPeerConnection();firefoxShim.shimOnTrack();break;case"edge":if(!edgeShim||!edgeShim.shimPeerConnection){logging("MS edge shim is not included in this adapter release.");return}logging("adapter.js shimming edge.");module.exports.browserShim=edgeShim;edgeShim.shimGetUserMedia();edgeShim.shimPeerConnection();break;case"safari":if(!safariShim){logging("Safari shim is not included in this adapter release.");return}logging("adapter.js shimming safari.");module.exports.browserShim=safariShim;safariShim.shimGetUserMedia();break;default:logging("Unsupported browser!")}})()},{"./chrome/chrome_shim":39,"./edge/edge_shim":41,"./firefox/firefox_shim":43,"./safari/safari_shim":45,"./utils":46}],39:[function(require,module,exports){"use strict";var logging=require("../utils.js").log;var browserDetails=require("../utils.js").browserDetails;var chromeShim={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){if(typeof window==="object"&&window.RTCPeerConnection&&!("ontrack"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(f){var self=this;if(this._ontrack){this.removeEventListener("track",this._ontrack);this.removeEventListener("addstream",this._ontrackpoly)}this.addEventListener("track",this._ontrack=f);this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(te){var event=new Event("track");event.track=te.track;event.receiver={track:te.track};event.streams=[e.stream];self.dispatchEvent(event)});e.stream.getTracks().forEach(function(track){var event=new Event("track");event.track=track;event.receiver={track:track};event.streams=[e.stream];this.dispatchEvent(event)}.bind(this))}.bind(this))}})}},shimSourceObject:function(){if(typeof window==="object"){if(window.HTMLMediaElement&&!("srcObject"in window.HTMLMediaElement.prototype)){Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(stream){var self=this;this._srcObject=stream;if(this.src){URL.revokeObjectURL(this.src)}if(!stream){this.src="";return}this.src=URL.createObjectURL(stream);stream.addEventListener("addtrack",function(){if(self.src){URL.revokeObjectURL(self.src)}self.src=URL.createObjectURL(stream)});stream.addEventListener("removetrack",function(){if(self.src){URL.revokeObjectURL(self.src)}self.src=URL.createObjectURL(stream)})}})}}},shimPeerConnection:function(){window.RTCPeerConnection=function(pcConfig,pcConstraints){logging("PeerConnection");if(pcConfig&&pcConfig.iceTransportPolicy){pcConfig.iceTransports=pcConfig.iceTransportPolicy}var pc=new webkitRTCPeerConnection(pcConfig,pcConstraints);var origGetStats=pc.getStats.bind(pc);pc.getStats=function(selector,successCallback,errorCallback){var self=this;var args=arguments;if(arguments.length>0&&typeof selector==="function"){return origGetStats(selector,successCallback)}var fixChromeStats_=function(response){var standardReport={};var reports=response.result();reports.forEach(function(report){var standardStats={id:report.id,timestamp:report.timestamp,type:report.type};report.names().forEach(function(name){standardStats[name]=report.stat(name)});standardReport[standardStats.id]=standardStats});return standardReport};var makeMapStats=function(stats,legacyStats){var map=new Map(Object.keys(stats).map(function(key){return[key,stats[key]]}));legacyStats=legacyStats||stats;Object.keys(legacyStats).forEach(function(key){map[key]=legacyStats[key]});return map};if(arguments.length>=2){var successCallbackWrapper_=function(response){args[1](makeMapStats(fixChromeStats_(response)))};return origGetStats.apply(this,[successCallbackWrapper_,arguments[0]])}return new Promise(function(resolve,reject){if(args.length===1&&typeof selector==="object"){origGetStats.apply(self,[function(response){resolve(makeMapStats(fixChromeStats_(response)))},reject])}else{origGetStats.apply(self,[function(response){resolve(makeMapStats(fixChromeStats_(response),response.result()))},reject])}}).then(successCallback,errorCallback)};return pc};window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype;if(webkitRTCPeerConnection.generateCertificate){Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}})}["createOffer","createAnswer"].forEach(function(method){var nativeMethod=webkitRTCPeerConnection.prototype[method];webkitRTCPeerConnection.prototype[method]=function(){var self=this;if(arguments.length<1||arguments.length===1&&typeof arguments[0]==="object"){var opts=arguments.length===1?arguments[0]:undefined;return new Promise(function(resolve,reject){nativeMethod.apply(self,[resolve,reject,opts])})}return nativeMethod.apply(this,arguments)}});if(browserDetails.version<51){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=webkitRTCPeerConnection.prototype[method];webkitRTCPeerConnection.prototype[method]=function(){var args=arguments;var self=this;var promise=new Promise(function(resolve,reject){nativeMethod.apply(self,[args[0],resolve,reject])});if(args.length<2){return promise}return promise.then(function(){args[1].apply(null,[])},function(err){if(args.length>=3){args[2].apply(null,[err])}})}})}var nativeAddIceCandidate=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]===null?Promise.resolve():nativeAddIceCandidate.apply(this,arguments)};["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=webkitRTCPeerConnection.prototype[method];webkitRTCPeerConnection.prototype[method]=function(){arguments[0]=new(method==="addIceCandidate"?RTCIceCandidate:RTCSessionDescription)(arguments[0]);return nativeMethod.apply(this,arguments)}})},attachMediaStream:function(element,stream){logging("DEPRECATED, attachMediaStream will soon be removed.");if(browserDetails.version>=43){element.srcObject=stream}else if(typeof element.src!=="undefined"){element.src=URL.createObjectURL(stream)}else{logging("Error attaching stream to element.")}},reattachMediaStream:function(to,from){logging("DEPRECATED, reattachMediaStream will soon be removed.");if(browserDetails.version>=43){to.srcObject=from.srcObject}else{to.src=from.src}}};module.exports={shimMediaStream:chromeShim.shimMediaStream,shimOnTrack:chromeShim.shimOnTrack,shimSourceObject:chromeShim.shimSourceObject,shimPeerConnection:chromeShim.shimPeerConnection,shimGetUserMedia:require("./getusermedia"),attachMediaStream:chromeShim.attachMediaStream,reattachMediaStream:chromeShim.reattachMediaStream}},{"../utils.js":46,"./getusermedia":40}],40:[function(require,module,exports){"use strict";var logging=require("../utils.js").log;module.exports=function(){var constraintsToChrome_=function(c){if(typeof c!=="object"||c.mandatory||c.optional){return c}var cc={};Object.keys(c).forEach(function(key){if(key==="require"||key==="advanced"||key==="mediaSource"){return}var r=typeof c[key]==="object"?c[key]:{ideal:c[key]};if(r.exact!==undefined&&typeof r.exact==="number"){r.min=r.max=r.exact}var oldname_=function(prefix,name){if(prefix){return prefix+name.charAt(0).toUpperCase()+name.slice(1)}return name==="deviceId"?"sourceId":name};if(r.ideal!==undefined){cc.optional=cc.optional||[];var oc={};if(typeof r.ideal==="number"){oc[oldname_("min",key)]=r.ideal;cc.optional.push(oc);oc={};oc[oldname_("max",key)]=r.ideal;cc.optional.push(oc)}else{oc[oldname_("",key)]=r.ideal;cc.optional.push(oc)}}if(r.exact!==undefined&&typeof r.exact!=="number"){cc.mandatory=cc.mandatory||{};cc.mandatory[oldname_("",key)]=r.exact}else{["min","max"].forEach(function(mix){if(r[mix]!==undefined){cc.mandatory=cc.mandatory||{};cc.mandatory[oldname_(mix,key)]=r[mix]}})}});if(c.advanced){cc.optional=(cc.optional||[]).concat(c.advanced)}return cc};var shimConstraints_=function(constraints,func){constraints=JSON.parse(JSON.stringify(constraints));if(constraints&&constraints.audio){constraints.audio=constraintsToChrome_(constraints.audio)}if(constraints&&typeof constraints.video==="object"){var face=constraints.video.facingMode;face=face&&(typeof face==="object"?face:{ideal:face});if(face&&(face.exact==="user"||face.exact==="environment"||face.ideal==="user"||face.ideal==="environment")&&!(navigator.mediaDevices.getSupportedConstraints&&navigator.mediaDevices.getSupportedConstraints().facingMode)){delete constraints.video.facingMode;if(face.exact==="environment"||face.ideal==="environment"){return navigator.mediaDevices.enumerateDevices().then(function(devices){devices=devices.filter(function(d){return d.kind==="videoinput"});var back=devices.find(function(d){return d.label.toLowerCase().indexOf("back")!==-1})||devices.length&&devices[devices.length-1];if(back){constraints.video.deviceId=face.exact?{exact:back.deviceId}:{ideal:back.deviceId}}constraints.video=constraintsToChrome_(constraints.video);logging("chrome: "+JSON.stringify(constraints));return func(constraints)})}}constraints.video=constraintsToChrome_(constraints.video)}logging("chrome: "+JSON.stringify(constraints));return func(constraints)};var shimError_=function(e){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};var getUserMedia_=function(constraints,onSuccess,onError){shimConstraints_(constraints,function(c){navigator.webkitGetUserMedia(c,onSuccess,function(e){onError(shimError_(e))})})};navigator.getUserMedia=getUserMedia_;var getUserMediaPromise_=function(constraints){return new Promise(function(resolve,reject){navigator.getUserMedia(constraints,resolve,reject)})};if(!navigator.mediaDevices){navigator.mediaDevices={getUserMedia:getUserMediaPromise_,enumerateDevices:function(){return new Promise(function(resolve){var kinds={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(devices){resolve(devices.map(function(device){return{label:device.label,kind:kinds[device.kind],deviceId:device.id,groupId:""}}))})})}}}if(!navigator.mediaDevices.getUserMedia){navigator.mediaDevices.getUserMedia=function(constraints){return getUserMediaPromise_(constraints)}}else{var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(cs){return shimConstraints_(cs,function(c){return origGetUserMedia(c).catch(function(e){return Promise.reject(shimError_(e))})})}}if(typeof navigator.mediaDevices.addEventListener==="undefined"){navigator.mediaDevices.addEventListener=function(){logging("Dummy mediaDevices.addEventListener called.")}}if(typeof navigator.mediaDevices.removeEventListener==="undefined"){navigator.mediaDevices.removeEventListener=function(){logging("Dummy mediaDevices.removeEventListener called.")}}}},{"../utils.js":46}],41:[function(require,module,exports){"use strict";var SDPUtils=require("sdp");var logging=require("../utils").log;var edgeShim={shimPeerConnection:function(){if(window.RTCIceGatherer){if(!window.RTCIceCandidate){window.RTCIceCandidate=function(args){return args}}if(!window.RTCSessionDescription){window.RTCSessionDescription=function(args){return args}}}window.RTCPeerConnection=function(config){var self=this;var _eventTarget=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach(function(method){self[method]=_eventTarget[method].bind(_eventTarget)});this.onicecandidate=null;this.onaddstream=null;this.ontrack=null;this.onremovestream=null;this.onsignalingstatechange=null;this.oniceconnectionstatechange=null;this.onnegotiationneeded=null;this.ondatachannel=null;this.localStreams=[];this.remoteStreams=[];this.getLocalStreams=function(){return self.localStreams};this.getRemoteStreams=function(){return self.remoteStreams};this.localDescription=new RTCSessionDescription({type:"",sdp:""});this.remoteDescription=new RTCSessionDescription({type:"",sdp:""});this.signalingState="stable";this.iceConnectionState="new";this.iceGatheringState="new";this.iceOptions={gatherPolicy:"all",iceServers:[]};if(config&&config.iceTransportPolicy){switch(config.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=config.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported');default:break}}this.usingBundle=config&&config.bundlePolicy==="max-bundle";if(config&&config.iceServers){var iceServers=JSON.parse(JSON.stringify(config.iceServers));this.iceOptions.iceServers=iceServers.filter(function(server){if(server&&server.urls){var urls=server.urls;if(typeof urls==="string"){urls=[urls]}urls=urls.filter(function(url){return url.indexOf("turn:")===0&&url.indexOf("transport=udp")!==-1})[0];return!!urls}return false})}this.transceivers=[];this._localIceCandidatesBuffer=[]};window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var self=this;var sections=SDPUtils.splitSections(self.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(event){var end=!event.candidate||Object.keys(event.candidate).length===0;if(end){for(var j=1;j<sections.length;j++){if(sections[j].indexOf("\r\na=end-of-candidates\r\n")===-1){sections[j]+="a=end-of-candidates\r\n"}}}else if(event.candidate.candidate.indexOf("typ endOfCandidates")===-1){sections[event.candidate.sdpMLineIndex+1]+="a="+event.candidate.candidate+"\r\n"}self.localDescription.sdp=sections.join("");self.dispatchEvent(event);if(self.onicecandidate!==null){self.onicecandidate(event)}if(!event.candidate&&self.iceGatheringState!=="complete"){var complete=self.transceivers.every(function(transceiver){return transceiver.iceGatherer&&transceiver.iceGatherer.state==="completed"});if(complete){self.iceGatheringState="complete"}}});this._localIceCandidatesBuffer=[]};window.RTCPeerConnection.prototype.addStream=function(stream){this.localStreams.push(stream.clone());this._maybeFireNegotiationNeeded()};window.RTCPeerConnection.prototype.removeStream=function(stream){var idx=this.localStreams.indexOf(stream);if(idx>-1){this.localStreams.splice(idx,1);this._maybeFireNegotiationNeeded()}};window.RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpSender}).map(function(transceiver){return transceiver.rtpSender})};window.RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpReceiver}).map(function(transceiver){return transceiver.rtpReceiver})};window.RTCPeerConnection.prototype._getCommonCapabilities=function(localCapabilities,remoteCapabilities){var commonCapabilities={codecs:[],headerExtensions:[],fecMechanisms:[]};localCapabilities.codecs.forEach(function(lCodec){for(var i=0;i<remoteCapabilities.codecs.length;i++){var rCodec=remoteCapabilities.codecs[i];if(lCodec.name.toLowerCase()===rCodec.name.toLowerCase()&&lCodec.clockRate===rCodec.clockRate&&lCodec.numChannels===rCodec.numChannels){commonCapabilities.codecs.push(rCodec);break}}});localCapabilities.headerExtensions.forEach(function(lHeaderExtension){for(var i=0;i<remoteCapabilities.headerExtensions.length;i++){var rHeaderExtension=remoteCapabilities.headerExtensions[i];if(lHeaderExtension.uri===rHeaderExtension.uri){commonCapabilities.headerExtensions.push(rHeaderExtension);break}}});return commonCapabilities};window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(mid,sdpMLineIndex){var self=this;var iceGatherer=new RTCIceGatherer(self.iceOptions);var iceTransport=new RTCIceTransport(iceGatherer);iceGatherer.onlocalcandidate=function(evt){var event=new Event("icecandidate");event.candidate={sdpMid:mid,sdpMLineIndex:sdpMLineIndex};var cand=evt.candidate;var end=!cand||Object.keys(cand).length===0;if(end){if(iceGatherer.state===undefined){iceGatherer.state="completed"}event.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"}else{cand.component=iceTransport.component==="RTCP"?2:1;event.candidate.candidate=SDPUtils.writeCandidate(cand)}var sections=SDPUtils.splitSections(self.localDescription.sdp);if(event.candidate.candidate.indexOf("typ endOfCandidates")===-1){sections[event.candidate.sdpMLineIndex+1]+="a="+event.candidate.candidate+"\r\n"}else{sections[event.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n"}self.localDescription.sdp=sections.join("");var complete=self.transceivers.every(function(transceiver){return transceiver.iceGatherer&&transceiver.iceGatherer.state==="completed"});switch(self.iceGatheringState){case"new":self._localIceCandidatesBuffer.push(event);if(end&&complete){self._localIceCandidatesBuffer.push(new Event("icecandidate"))}break;case"gathering":self._emitBufferedCandidates();self.dispatchEvent(event);if(self.onicecandidate!==null){self.onicecandidate(event)}if(complete){self.dispatchEvent(new Event("icecandidate"));if(self.onicecandidate!==null){self.onicecandidate(new Event("icecandidate"))}self.iceGatheringState="complete"}break;case"complete":break;default:break}};iceTransport.onicestatechange=function(){self._updateConnectionState()};var dtlsTransport=new RTCDtlsTransport(iceTransport);dtlsTransport.ondtlsstatechange=function(){self._updateConnectionState()};dtlsTransport.onerror=function(){dtlsTransport.state="failed";self._updateConnectionState()};return{iceGatherer:iceGatherer,iceTransport:iceTransport,dtlsTransport:dtlsTransport}};window.RTCPeerConnection.prototype._transceive=function(transceiver,send,recv){var params=this._getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);if(send&&transceiver.rtpSender){params.encodings=transceiver.sendEncodingParameters;params.rtcp={cname:SDPUtils.localCName};if(transceiver.recvEncodingParameters.length){params.rtcp.ssrc=transceiver.recvEncodingParameters[0].ssrc}transceiver.rtpSender.send(params)}if(recv&&transceiver.rtpReceiver){params.encodings=transceiver.recvEncodingParameters;params.rtcp={cname:transceiver.cname};if(transceiver.sendEncodingParameters.length){params.rtcp.ssrc=transceiver.sendEncodingParameters[0].ssrc}transceiver.rtpReceiver.receive(params)}};window.RTCPeerConnection.prototype.setLocalDescription=function(description){var self=this;var sections;var sessionpart;if(description.type==="offer"){if(this._pendingOffer){sections=SDPUtils.splitSections(description.sdp);sessionpart=sections.shift();sections.forEach(function(mediaSection,sdpMLineIndex){var caps=SDPUtils.parseRtpParameters(mediaSection);self._pendingOffer[sdpMLineIndex].localCapabilities=caps});this.transceivers=this._pendingOffer;delete this._pendingOffer}}else if(description.type==="answer"){sections=SDPUtils.splitSections(self.remoteDescription.sdp);sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver=self.transceivers[sdpMLineIndex];var iceGatherer=transceiver.iceGatherer;var iceTransport=transceiver.iceTransport;var dtlsTransport=transceiver.dtlsTransport;var localCapabilities=transceiver.localCapabilities;var remoteCapabilities=transceiver.remoteCapabilities;var rejected=mediaSection.split("\n",1)[0].split(" ",2)[1]==="0";if(!rejected){var remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);if(isIceLite){var cands=SDPUtils.matchPrefix(mediaSection,"a=candidate:").map(function(cand){return SDPUtils.parseCandidate(cand)}).filter(function(cand){return cand.component==="1"});if(cands.length){iceTransport.setRemoteCandidates(cands)}}var remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);if(isIceLite){remoteDtlsParameters.role="server"}if(!self.usingBundle||sdpMLineIndex===0){iceTransport.start(iceGatherer,remoteIceParameters,isIceLite?"controlling":"controlled");dtlsTransport.start(remoteDtlsParameters)}var params=self._getCommonCapabilities(localCapabilities,remoteCapabilities);self._transceive(transceiver,params.codecs.length>0,false)}})}this.localDescription={type:description.type,sdp:description.sdp};switch(description.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+description.type+'"')}var hasCallback=arguments.length>1&&typeof arguments[1]==="function";if(hasCallback){var cb=arguments[1];window.setTimeout(function(){cb();if(self.iceGatheringState==="new"){self.iceGatheringState="gathering"}self._emitBufferedCandidates()},0)}var p=Promise.resolve();p.then(function(){if(!hasCallback){if(self.iceGatheringState==="new"){self.iceGatheringState="gathering"}window.setTimeout(self._emitBufferedCandidates.bind(self),500)}});return p};window.RTCPeerConnection.prototype.setRemoteDescription=function(description){var self=this;var stream=new MediaStream;var receiverList=[];var sections=SDPUtils.splitSections(description.sdp);var sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;this.usingBundle=SDPUtils.matchPrefix(sessionpart,"a=group:BUNDLE ").length>0;sections.forEach(function(mediaSection,sdpMLineIndex){var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].substr(2).split(" ");var kind=mline[0];var rejected=mline[1]==="0";var direction=SDPUtils.getDirection(mediaSection,sessionpart);var transceiver;var iceGatherer;var iceTransport;var dtlsTransport;var rtpSender;var rtpReceiver;var sendEncodingParameters;var recvEncodingParameters;var localCapabilities;var track;var remoteCapabilities=SDPUtils.parseRtpParameters(mediaSection);var remoteIceParameters;var remoteDtlsParameters;if(!rejected){remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);remoteDtlsParameters.role="client"}recvEncodingParameters=SDPUtils.parseRtpEncodingParameters(mediaSection);var mid=SDPUtils.matchPrefix(mediaSection,"a=mid:");if(mid.length){mid=mid[0].substr(6)}else{mid=SDPUtils.generateIdentifier()}var cname;var remoteSsrc=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(obj){return obj.attribute==="cname"})[0];if(remoteSsrc){cname=remoteSsrc.value}var isComplete=SDPUtils.matchPrefix(mediaSection,"a=end-of-candidates").length>0;var cands=SDPUtils.matchPrefix(mediaSection,"a=candidate:").map(function(cand){return SDPUtils.parseCandidate(cand)}).filter(function(cand){return cand.component==="1"});if(description.type==="offer"&&!rejected){var transports=self.usingBundle&&sdpMLineIndex>0?{iceGatherer:self.transceivers[0].iceGatherer,iceTransport:self.transceivers[0].iceTransport,dtlsTransport:self.transceivers[0].dtlsTransport}:self._createIceAndDtlsTransports(mid,sdpMLineIndex);if(isComplete){transports.iceTransport.setRemoteCandidates(cands)}localCapabilities=RTCRtpReceiver.getCapabilities(kind);sendEncodingParameters=[{ssrc:(2*sdpMLineIndex+2)*1001}];rtpReceiver=new RTCRtpReceiver(transports.dtlsTransport,kind);track=rtpReceiver.track;receiverList.push([track,rtpReceiver]);stream.addTrack(track);if(self.localStreams.length>0&&self.localStreams[0].getTracks().length>=sdpMLineIndex){var localtrack=self.localStreams[0].getTracks()[sdpMLineIndex];rtpSender=new RTCRtpSender(localtrack,transports.dtlsTransport)}self.transceivers[sdpMLineIndex]={iceGatherer:transports.iceGatherer,iceTransport:transports.iceTransport,dtlsTransport:transports.dtlsTransport,localCapabilities:localCapabilities,remoteCapabilities:remoteCapabilities,rtpSender:rtpSender,rtpReceiver:rtpReceiver,kind:kind,mid:mid,cname:cname,sendEncodingParameters:sendEncodingParameters,recvEncodingParameters:recvEncodingParameters};self._transceive(self.transceivers[sdpMLineIndex],false,direction==="sendrecv"||direction==="sendonly")}else if(description.type==="answer"&&!rejected){transceiver=self.transceivers[sdpMLineIndex];iceGatherer=transceiver.iceGatherer;iceTransport=transceiver.iceTransport;dtlsTransport=transceiver.dtlsTransport;rtpSender=transceiver.rtpSender;rtpReceiver=transceiver.rtpReceiver;sendEncodingParameters=transceiver.sendEncodingParameters;localCapabilities=transceiver.localCapabilities;self.transceivers[sdpMLineIndex].recvEncodingParameters=recvEncodingParameters;self.transceivers[sdpMLineIndex].remoteCapabilities=remoteCapabilities;self.transceivers[sdpMLineIndex].cname=cname;if((isIceLite||isComplete)&&cands.length){iceTransport.setRemoteCandidates(cands)}if(!self.usingBundle||sdpMLineIndex===0){iceTransport.start(iceGatherer,remoteIceParameters,"controlling");dtlsTransport.start(remoteDtlsParameters)}self._transceive(transceiver,direction==="sendrecv"||direction==="recvonly",direction==="sendrecv"||direction==="sendonly");if(rtpReceiver&&(direction==="sendrecv"||direction==="sendonly")){track=rtpReceiver.track;receiverList.push([track,rtpReceiver]);stream.addTrack(track)}else{delete transceiver.rtpReceiver}}});this.remoteDescription={type:description.type,sdp:description.sdp};switch(description.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+description.type+'"')}if(stream.getTracks().length){self.remoteStreams.push(stream);window.setTimeout(function(){var event=new Event("addstream");event.stream=stream;self.dispatchEvent(event);if(self.onaddstream!==null){window.setTimeout(function(){self.onaddstream(event)},0)}receiverList.forEach(function(item){var track=item[0];var receiver=item[1];var trackEvent=new Event("track");trackEvent.track=track;trackEvent.receiver=receiver;trackEvent.streams=[stream];self.dispatchEvent(event);if(self.ontrack!==null){window.setTimeout(function(){self.ontrack(trackEvent)},0)}})},0)}if(arguments.length>1&&typeof arguments[1]==="function"){window.setTimeout(arguments[1],0)}return Promise.resolve()};window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(transceiver){if(transceiver.iceTransport){transceiver.iceTransport.stop()}if(transceiver.dtlsTransport){transceiver.dtlsTransport.stop()}if(transceiver.rtpSender){transceiver.rtpSender.stop()}if(transceiver.rtpReceiver){transceiver.rtpReceiver.stop()}});this._updateSignalingState("closed")};window.RTCPeerConnection.prototype._updateSignalingState=function(newState){this.signalingState=newState;var event=new Event("signalingstatechange");this.dispatchEvent(event);if(this.onsignalingstatechange!==null){
this.onsignalingstatechange(event)}};window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var event=new Event("negotiationneeded");this.dispatchEvent(event);if(this.onnegotiationneeded!==null){this.onnegotiationneeded(event)}};window.RTCPeerConnection.prototype._updateConnectionState=function(){var self=this;var newState;var states={"new":0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};this.transceivers.forEach(function(transceiver){states[transceiver.iceTransport.state]++;states[transceiver.dtlsTransport.state]++});states.connected+=states.completed;newState="new";if(states.failed>0){newState="failed"}else if(states.connecting>0||states.checking>0){newState="connecting"}else if(states.disconnected>0){newState="disconnected"}else if(states.new>0){newState="new"}else if(states.connected>0||states.completed>0){newState="connected"}if(newState!==self.iceConnectionState){self.iceConnectionState=newState;var event=new Event("iceconnectionstatechange");this.dispatchEvent(event);if(this.oniceconnectionstatechange!==null){this.oniceconnectionstatechange(event)}}};window.RTCPeerConnection.prototype.createOffer=function(){var self=this;if(this._pendingOffer){throw new Error("createOffer called while there is a pending offer.")}var offerOptions;if(arguments.length===1&&typeof arguments[0]!=="function"){offerOptions=arguments[0]}else if(arguments.length===3){offerOptions=arguments[2]}var tracks=[];var numAudioTracks=0;var numVideoTracks=0;if(this.localStreams.length){numAudioTracks=this.localStreams[0].getAudioTracks().length;numVideoTracks=this.localStreams[0].getVideoTracks().length}if(offerOptions){if(offerOptions.mandatory||offerOptions.optional){throw new TypeError("Legacy mandatory/optional constraints not supported.")}if(offerOptions.offerToReceiveAudio!==undefined){numAudioTracks=offerOptions.offerToReceiveAudio}if(offerOptions.offerToReceiveVideo!==undefined){numVideoTracks=offerOptions.offerToReceiveVideo}}if(this.localStreams.length){this.localStreams[0].getTracks().forEach(function(track){tracks.push({kind:track.kind,track:track,wantReceive:track.kind==="audio"?numAudioTracks>0:numVideoTracks>0});if(track.kind==="audio"){numAudioTracks--}else if(track.kind==="video"){numVideoTracks--}})}while(numAudioTracks>0||numVideoTracks>0){if(numAudioTracks>0){tracks.push({kind:"audio",wantReceive:true});numAudioTracks--}if(numVideoTracks>0){tracks.push({kind:"video",wantReceive:true});numVideoTracks--}}var sdp=SDPUtils.writeSessionBoilerplate();var transceivers=[];tracks.forEach(function(mline,sdpMLineIndex){var track=mline.track;var kind=mline.kind;var mid=SDPUtils.generateIdentifier();var transports=self.usingBundle&&sdpMLineIndex>0?{iceGatherer:transceivers[0].iceGatherer,iceTransport:transceivers[0].iceTransport,dtlsTransport:transceivers[0].dtlsTransport}:self._createIceAndDtlsTransports(mid,sdpMLineIndex);var localCapabilities=RTCRtpSender.getCapabilities(kind);var rtpSender;var rtpReceiver;var sendEncodingParameters=[{ssrc:(2*sdpMLineIndex+1)*1001}];if(track){rtpSender=new RTCRtpSender(track,transports.dtlsTransport)}if(mline.wantReceive){rtpReceiver=new RTCRtpReceiver(transports.dtlsTransport,kind)}transceivers[sdpMLineIndex]={iceGatherer:transports.iceGatherer,iceTransport:transports.iceTransport,dtlsTransport:transports.dtlsTransport,localCapabilities:localCapabilities,remoteCapabilities:null,rtpSender:rtpSender,rtpReceiver:rtpReceiver,kind:kind,mid:mid,sendEncodingParameters:sendEncodingParameters,recvEncodingParameters:null}});if(this.usingBundle){sdp+="a=group:BUNDLE "+transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}tracks.forEach(function(mline,sdpMLineIndex){var transceiver=transceivers[sdpMLineIndex];sdp+=SDPUtils.writeMediaSection(transceiver,transceiver.localCapabilities,"offer",self.localStreams[0])});this._pendingOffer=transceivers;var desc=new RTCSessionDescription({type:"offer",sdp:sdp});if(arguments.length&&typeof arguments[0]==="function"){window.setTimeout(arguments[0],0,desc)}return Promise.resolve(desc)};window.RTCPeerConnection.prototype.createAnswer=function(){var self=this;var sdp=SDPUtils.writeSessionBoilerplate();if(this.usingBundle){sdp+="a=group:BUNDLE "+this.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}this.transceivers.forEach(function(transceiver){var commonCapabilities=self._getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);sdp+=SDPUtils.writeMediaSection(transceiver,commonCapabilities,"answer",self.localStreams[0])});var desc=new RTCSessionDescription({type:"answer",sdp:sdp});if(arguments.length&&typeof arguments[0]==="function"){window.setTimeout(arguments[0],0,desc)}return Promise.resolve(desc)};window.RTCPeerConnection.prototype.addIceCandidate=function(candidate){if(candidate===null){this.transceivers.forEach(function(transceiver){transceiver.iceTransport.addRemoteCandidate({})})}else{var mLineIndex=candidate.sdpMLineIndex;if(candidate.sdpMid){for(var i=0;i<this.transceivers.length;i++){if(this.transceivers[i].mid===candidate.sdpMid){mLineIndex=i;break}}}var transceiver=this.transceivers[mLineIndex];if(transceiver){var cand=Object.keys(candidate.candidate).length>0?SDPUtils.parseCandidate(candidate.candidate):{};if(cand.protocol==="tcp"&&cand.port===0){return}if(cand.component!=="1"){return}if(cand.type==="endOfCandidates"){cand={}}transceiver.iceTransport.addRemoteCandidate(cand);var sections=SDPUtils.splitSections(this.remoteDescription.sdp);sections[mLineIndex+1]+=(cand.type?candidate.candidate.trim():"a=end-of-candidates")+"\r\n";this.remoteDescription.sdp=sections.join("")}}if(arguments.length>1&&typeof arguments[1]==="function"){window.setTimeout(arguments[1],0)}return Promise.resolve()};window.RTCPeerConnection.prototype.getStats=function(){var promises=[];this.transceivers.forEach(function(transceiver){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(method){if(transceiver[method]){promises.push(transceiver[method].getStats())}})});var cb=arguments.length>1&&typeof arguments[1]==="function"&&arguments[1];return new Promise(function(resolve){var results=new Map;Promise.all(promises).then(function(res){res.forEach(function(result){Object.keys(result).forEach(function(id){results.set(id,result[id]);results[id]=result[id]})});if(cb){window.setTimeout(cb,0,results)}resolve(results)})})}},attachMediaStream:function(element,stream){logging("DEPRECATED, attachMediaStream will soon be removed.");element.srcObject=stream},reattachMediaStream:function(to,from){logging("DEPRECATED, reattachMediaStream will soon be removed.");to.srcObject=from.srcObject}};module.exports={shimPeerConnection:edgeShim.shimPeerConnection,shimGetUserMedia:require("./getusermedia"),attachMediaStream:edgeShim.attachMediaStream,reattachMediaStream:edgeShim.reattachMediaStream}},{"../utils":46,"./getusermedia":42,sdp:23}],42:[function(require,module,exports){"use strict";module.exports=function(){var shimError_=function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}};var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return origGetUserMedia(c).catch(function(e){return Promise.reject(shimError_(e))})}}},{}],43:[function(require,module,exports){"use strict";var logging=require("../utils").log;var browserDetails=require("../utils").browserDetails;var firefoxShim={shimOnTrack:function(){if(typeof window==="object"&&window.RTCPeerConnection&&!("ontrack"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(f){if(this._ontrack){this.removeEventListener("track",this._ontrack);this.removeEventListener("addstream",this._ontrackpoly)}this.addEventListener("track",this._ontrack=f);this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(track){var event=new Event("track");event.track=track;event.receiver={track:track};event.streams=[e.stream];this.dispatchEvent(event)}.bind(this))}.bind(this))}})}},shimSourceObject:function(){if(typeof window==="object"){if(window.HTMLMediaElement&&!("srcObject"in window.HTMLMediaElement.prototype)){Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(stream){this.mozSrcObject=stream}})}}},shimPeerConnection:function(){if(typeof window!=="object"||!(window.RTCPeerConnection||window.mozRTCPeerConnection)){return}if(!window.RTCPeerConnection){window.RTCPeerConnection=function(pcConfig,pcConstraints){if(browserDetails.version<38){if(pcConfig&&pcConfig.iceServers){var newIceServers=[];for(var i=0;i<pcConfig.iceServers.length;i++){var server=pcConfig.iceServers[i];if(server.hasOwnProperty("urls")){for(var j=0;j<server.urls.length;j++){var newServer={url:server.urls[j]};if(server.urls[j].indexOf("turn")===0){newServer.username=server.username;newServer.credential=server.credential}newIceServers.push(newServer)}}else{newIceServers.push(pcConfig.iceServers[i])}}pcConfig.iceServers=newIceServers}}return new mozRTCPeerConnection(pcConfig,pcConstraints)};window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype;if(mozRTCPeerConnection.generateCertificate){Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}})}window.RTCSessionDescription=mozRTCSessionDescription;window.RTCIceCandidate=mozRTCIceCandidate}["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){arguments[0]=new(method==="addIceCandidate"?RTCIceCandidate:RTCSessionDescription)(arguments[0]);return nativeMethod.apply(this,arguments)}});var nativeAddIceCandidate=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]===null?Promise.resolve():nativeAddIceCandidate.apply(this,arguments)};var makeMapStats=function(stats){var map=new Map;Object.keys(stats).forEach(function(key){map.set(key,stats[key]);map[key]=stats[key]});return map};var nativeGetStats=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(selector,onSucc,onErr){return nativeGetStats.apply(this,[selector||null]).then(function(stats){return makeMapStats(stats)}).then(onSucc,onErr)}},attachMediaStream:function(element,stream){logging("DEPRECATED, attachMediaStream will soon be removed.");element.srcObject=stream},reattachMediaStream:function(to,from){logging("DEPRECATED, reattachMediaStream will soon be removed.");to.srcObject=from.srcObject}};module.exports={shimOnTrack:firefoxShim.shimOnTrack,shimSourceObject:firefoxShim.shimSourceObject,shimPeerConnection:firefoxShim.shimPeerConnection,shimGetUserMedia:require("./getusermedia"),attachMediaStream:firefoxShim.attachMediaStream,reattachMediaStream:firefoxShim.reattachMediaStream}},{"../utils":46,"./getusermedia":44}],44:[function(require,module,exports){"use strict";var logging=require("../utils").log;var browserDetails=require("../utils").browserDetails;module.exports=function(){var shimError_=function(e){return{name:{SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the "+"user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}};var getUserMedia_=function(constraints,onSuccess,onError){var constraintsToFF37_=function(c){if(typeof c!=="object"||c.require){return c}var require=[];Object.keys(c).forEach(function(key){if(key==="require"||key==="advanced"||key==="mediaSource"){return}var r=c[key]=typeof c[key]==="object"?c[key]:{ideal:c[key]};if(r.min!==undefined||r.max!==undefined||r.exact!==undefined){require.push(key)}if(r.exact!==undefined){if(typeof r.exact==="number"){r.min=r.max=r.exact}else{c[key]=r.exact}delete r.exact}if(r.ideal!==undefined){c.advanced=c.advanced||[];var oc={};if(typeof r.ideal==="number"){oc[key]={min:r.ideal,max:r.ideal}}else{oc[key]=r.ideal}c.advanced.push(oc);delete r.ideal;if(!Object.keys(r).length){delete c[key]}}});if(require.length){c.require=require}return c};constraints=JSON.parse(JSON.stringify(constraints));if(browserDetails.version<38){logging("spec: "+JSON.stringify(constraints));if(constraints.audio){constraints.audio=constraintsToFF37_(constraints.audio)}if(constraints.video){constraints.video=constraintsToFF37_(constraints.video)}logging("ff37: "+JSON.stringify(constraints))}return navigator.mozGetUserMedia(constraints,onSuccess,function(e){onError(shimError_(e))})};var getUserMediaPromise_=function(constraints){return new Promise(function(resolve,reject){getUserMedia_(constraints,resolve,reject)})};if(!navigator.mediaDevices){navigator.mediaDevices={getUserMedia:getUserMediaPromise_,addEventListener:function(){},removeEventListener:function(){}}}navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(resolve){var infos=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];resolve(infos)})};if(browserDetails.version<41){var orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices().then(undefined,function(e){if(e.name==="NotFoundError"){return[]}throw e})}}if(browserDetails.version<49){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return origGetUserMedia(c).catch(function(e){return Promise.reject(shimError_(e))})}}navigator.getUserMedia=function(constraints,onSuccess,onError){if(browserDetails.version<44){return getUserMedia_(constraints,onSuccess,onError)}console.warn("navigator.getUserMedia has been replaced by "+"navigator.mediaDevices.getUserMedia");navigator.mediaDevices.getUserMedia(constraints).then(onSuccess,onError)}}},{"../utils":46}],45:[function(require,module,exports){"use strict";var safariShim={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};module.exports={shimGetUserMedia:safariShim.shimGetUserMedia}},{}],46:[function(require,module,exports){"use strict";var logDisabled_=true;var utils={disableLog:function(bool){if(typeof bool!=="boolean"){return new Error("Argument type: "+typeof bool+". Please use a boolean.")}logDisabled_=bool;return bool?"adapter.js logging disabled":"adapter.js logging enabled"},log:function(){if(typeof window==="object"){if(logDisabled_){return}if(typeof console!=="undefined"&&typeof console.log==="function"){console.log.apply(console,arguments)}}},extractVersion:function(uastring,expr,pos){var match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)},detectBrowser:function(){var result={};result.browser=null;result.version=null;result.minVersion=null;if(typeof window==="undefined"||!window.navigator){result.browser="Not a browser.";return result}if(navigator.mozGetUserMedia){result.browser="firefox";result.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1);result.minVersion=31}else if(navigator.webkitGetUserMedia){if(window.webkitRTCPeerConnection){result.browser="chrome";result.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);result.minVersion=38}else{if(navigator.userAgent.match(/Version\/(\d+).(\d+)/)){result.browser="safari";result.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1);result.minVersion=602}else{result.browser="Unsupported webkit-based browser "+"with GUM support but no WebRTC support.";return result}}}else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)){result.browser="edge";result.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2);result.minVersion=10547}else{result.browser="Not a supported browser.";return result}if(result.version<result.minVersion){utils.log("Browser: "+result.browser+" Version: "+result.version+" < minimum supported version: "+result.minVersion+"\n some things might not work!")}return result}};module.exports={log:utils.log,disableLog:utils.disableLog,browserDetails:utils.detectBrowser(),extractVersion:utils.extractVersion}},{}]},{},[1]);